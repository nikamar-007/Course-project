<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</title>
  <link rel="stylesheet" href="/style.css">
  <script src="js/init-landing.js" defer></script>
</head>

<body>

<header class="app-header">
  <div class="logo">üö∂‚Äç‚ôÇÔ∏è–ú–æ–π–ú–∞—Ä—à—Ä—É—Ç</div>
  <nav id="nav"></nav>
</header>

<div class="container feedback-container">
  <h2>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h2>
  <div id="feedbackContainer">

    <form id="feedbackForm" enctype="multipart/form-data">
      <div id="guestFields" style="display:none;">
        <input type="text" name="name" placeholder="–í–∞—à–µ –∏–º—è">
        <input type="email" name="email" placeholder="Email –¥–ª—è –æ—Ç–≤–µ—Ç–∞">
      </div>

      <select name="type" required>
        <option value="–∂–∞–ª–æ–±–∞">–ñ–∞–ª–æ–±–∞</option>
        <option value="–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</option>
        <option value="–±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å">–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å</option>
        <option value="–≤–æ–ø—Ä–æ—Å">–í–æ–ø—Ä–æ—Å</option>
        <option value="–æ—à–∏–±–∫–∞">–û—à–∏–±–∫–∞</option>
        <option value="–¥—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
      </select>

      <textarea name="message" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ" required></textarea>

      <input type="file" id="filesInput" multiple accept="image/*,.pdf,application/pdf">
      <div id="filesList" style="margin:10px 0;"></div>



      <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
    <div id="feedbackNavigation" style="display:flex; gap:10px; margin-top: 20px;">
      <button id="newFeedbackBtn" class="button" style="display:none;">–ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>
      <button id="myFeedbacksBtn" class="button" style="display:none;">–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</button>
    </div>

    <div id="feedbacksList" style="display:none; margin-top: 20px;"></div>
  </div>
</div>

<script>
function getGreeting() {
  const hour = new Date().getHours();
  if (hour >= 5 && hour < 12) return '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ';
  if (hour >= 12 && hour < 17) return '–î–æ–±—Ä—ã–π –¥–µ–Ω—å';
  if (hour >= 17 && hour < 23) return '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä';
  return '–î–æ–±—Ä–æ–π –Ω–æ—á–∏';
}

function initHeader() {
  fetch('/api/me.php')
    .then(r => {
      if (!r.ok) throw new Error();
      return r.json();
    })
    .then(user => {
      let adminLinks = '';
      if (user.role === 'admin') {
        adminLinks = `
          <div class="admin-dropdown">
            <button class="admin-dropbtn">
              –ê–¥–º–∏–Ω
              <span class="admin-badge">‚öôÔ∏è</span>
            </button>
            <div class="admin-dropdown-content">
              <a href="/admin/zones.html" class="nav-link">–ó–æ–Ω—ã —Ä–µ–º–æ–Ω—Ç–∞</a>
              <a href="/admin/users.html" class="nav-link">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
              <a href="/admin/feedback.html" class="nav-link">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</a>
              <a href="/admin/broadcast.html" class="nav-link">–†–∞—Å—Å—ã–ª–∫–∞</a>
            </div>
          </div>
        `;
      }
      
      const nav = document.getElementById('nav');

      if (!nav.dataset.initialized) {
        nav.innerHTML = `
          <div class="user-profile-header">
            <a href="/profile.html" title="–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å">
              <img
                id="headerAvatar"
                class="user-avatar"
                src="/uploads/avatars/Sun.jpg"
                alt="–ê–≤–∞—Ç–∞—Ä"
                width="40"
                height="40"
                loading="lazy"
                decoding="async"
              >
            </a>
            <span id="headerGreeting" class="greeting"></span>
          </div>

          <a href="/index.html" class="nav-link">–ö–∞—Ä—Ç–∞</a>
          <a href="/notifications.html" class="nav-link">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</a>
          <a href="/feedback.html" class="nav-link active">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</a>
          <a href="/profile.html" class="nav-link">–ü—Ä–æ—Ñ–∏–ª—å</a>
          ${adminLinks}
          <a href="/api/logout.php" class="nav-link">–í—ã—Ö–æ–¥</a>
        `;
        nav.dataset.initialized = '1';
      }

      const avatarImg = document.getElementById('headerAvatar');
      const greetingEl = document.getElementById('headerGreeting');

      const greeting = getGreeting();
      if (greetingEl) {
        greetingEl.textContent = `${greeting}, ${user.nickname || user.email}`;
      }

      const PLACEHOLDER = '/uploads/avatars/Sun.jpg';
      let newSrc = PLACEHOLDER;

      if (user.avatar_path && String(user.avatar_path).trim() !== '') {
        newSrc = user.avatar_path.startsWith('http')
          ? user.avatar_path
          : location.origin + user.avatar_path;
      }
      if (avatarImg && avatarImg.getAttribute('src') !== newSrc) {
        avatarImg.setAttribute('src', newSrc);
      }
      if (avatarImg) {
        avatarImg.onerror = () => {
          if (avatarImg.dataset.fallbackDone) return;
          avatarImg.dataset.fallbackDone = '1';
          avatarImg.src = PLACEHOLDER;
        };
      }


    })
    .catch(() => {
      document.getElementById('nav').innerHTML = `
        <a href="/index.html" class="nav-link">–ö–∞—Ä—Ç–∞</a>
        <a href="/login.html" class="nav-link">–í—Ö–æ–¥</a>
        <a href="/register.html" class="nav-link">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        <a href="/feedback.html" class="nav-link active">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</a>
      `;
      document.getElementById('guestFields').style.display = 'block';
    });
}

initHeader();

async function getUserInfo() {
  try {
    const res = await fetch('/api/me.php');
    if (res.ok) {
      return await res.json();
    }
  } catch (e) {
    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:', e);
  }
  return null;
}

const selectedFiles = [];
const filesInput = document.getElementById('filesInput');
const filesList = document.getElementById('filesList');

function renderFiles() {
  if (!selectedFiles.length) { filesList.innerHTML = ''; return; }

  filesList.innerHTML = selectedFiles.map((f, idx) => `
    <div style="display:flex;align-items:center;gap:10px;margin:6px 0;">
      <span>${f.name} (${Math.round(f.size/1024)} KB)</span>
      <button type="button" data-idx="${idx}" style="padding:4px 8px;">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  `).join('');

  filesList.querySelectorAll('button[data-idx]').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedFiles.splice(Number(btn.dataset.idx), 1);
      renderFiles();
    });
  });
}

filesInput.addEventListener('change', () => {
  for (const f of filesInput.files) selectedFiles.push(f);
  filesInput.value = ''; 
  renderFiles();
});

document.getElementById('feedbackForm').addEventListener('submit', async e => {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData();
  formData.append('type', form.querySelector('[name="type"]').value);
  formData.append('message', form.querySelector('[name="message"]').value);
  const nameEl = form.querySelector('[name="name"]');
  const emailEl = form.querySelector('[name="email"]');
  if (nameEl) formData.append('name', nameEl.value);
  if (emailEl) formData.append('email', emailEl.value);
  for (const f of selectedFiles) {
    formData.append('files[]', f);
  }

  try {
    const res = await fetch('/api/feedback.php', {
      method: 'POST',
      body: formData
    });

    const text = await res.text();
    console.log('RAW FEEDBACK RESPONSE:', text);

    let data;
    try { data = JSON.parse(text); } catch {
      showError('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É. –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.');
      return;
    }

    if (!res.ok || data.success === false) {
      showError((data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏') + (data.message ? (': ' + data.message) : ''));
      return;
    }

    showSuccess('–°–ø–∞—Å–∏–±–æ! –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. ID –≤–∞—à–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è: ' + data.id);
    form.reset();
    selectedFiles.length = 0;
    renderFiles();
    
    const user = await getUserInfo();
    if (!user) {
      const guestEmail = formData.get('email');
      if (guestEmail) {
        sessionStorage.setItem('guest_feedback_email', guestEmail);
        
        await fetch('/api/save-guest-email.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email: guestEmail })
        });
      }
      
      const guestFeedbacks = JSON.parse(sessionStorage.getItem('guest_feedbacks') || '[]');
      guestFeedbacks.push(data.id);
      sessionStorage.setItem('guest_feedbacks', JSON.stringify(guestFeedbacks));
      
      await fetch('/api/save-guest-feedback.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ feedback_id: data.id })
      });
    }
    
    window.location.href = `/feedback.html?id=${data.id}`;

  } catch (err) {
    console.error(err);
    showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  const feedbackId = params.get('id');

  const container = document.getElementById('feedbackContainer');
  const form = document.getElementById('feedbackForm');
  const feedbacksList = document.getElementById('feedbacksList');
  const newFeedbackBtn = document.getElementById('newFeedbackBtn');
  const myFeedbacksBtn = document.getElementById('myFeedbacksBtn');
  const feedbackNavigation = document.getElementById('feedbackNavigation');

  const escapeHtml = (text) => {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  };

  function showForm() {
    form.style.display = 'block';
    feedbacksList.style.display = 'none';
    feedbackNavigation.style.display = 'flex';
    newFeedbackBtn.style.display = 'none';
    myFeedbacksBtn.style.display = 'inline-block';
    
    const existingView = container.querySelector('.feedback-view');
    if (existingView) {
      existingView.remove();
    }
    
    if (!window.location.search.includes('id=')) {
      window.history.replaceState({}, document.title, '/feedback.html');
    }
  }

  async function loadMyFeedbacks() {
    try {
      const res = await fetch('/api/my-feedbacks.php');
      if (!res.ok) {
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π');
      }
      const data = await res.json();

      form.style.display = 'none';
      feedbackNavigation.style.display = 'flex';
      newFeedbackBtn.style.display = 'inline-block';
      myFeedbacksBtn.style.display = 'none';
      feedbacksList.style.display = 'block';

      const existingView = container.querySelector('.feedback-view');
      if (existingView) {
        existingView.remove();
      }

      if (!data || data.length === 0) {
        feedbacksList.innerHTML = `
          <div class="no-feedbacks">
            <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π</p>
            <button id="createFeedbackBtn" class="button">–°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>
          </div>
        `;
        document.getElementById('createFeedbackBtn')
          .addEventListener('click', showForm);
        return;
      }
      let html = `
        <h3>–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h3>
        <table class="feedbacks-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>–¢–∏–ø</th>
              <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
              <th>–î–∞—Ç–∞</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody>
      `;

      data.forEach(feedback => {
        const messagePreview = feedback.message.length > 50 
          ? feedback.message.substring(0, 50) + '...' 
          : feedback.message;
        
        const status = feedback.admin_reply ? '–û—Ç–≤–µ—á–µ–Ω–æ' : '–û–∂–∏–¥–∞–Ω–∏–µ';
        const statusClass = feedback.admin_reply ? 'status-answered' : 'status-pending';
        
        html += `
          <tr>
            <td>${feedback.id}</td>
            <td>${escapeHtml(feedback.type)}</td>
            <td>${escapeHtml(messagePreview)}</td>
            <td>${new Date(feedback.created_at).toLocaleDateString('ru-RU')}</td>
            <td><span class="status ${statusClass}">${status}</span></td>
            <td>
              <a href="/feedback.html?id=${feedback.id}" class="button small">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a>
            </td>
          </tr>
        `;
      });

      feedbacksList.innerHTML = html;
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π:', err);
      showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π: ' + err.message);
      showForm();
    }
  }
  async function loadFeedback(feedbackId) {
    try {
      const res = await fetch('/api/feedback.php?id=' + feedbackId);
      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
      }
      const data = await res.json();

      if (data.error) {
        showError(data.error);
        showForm();
        return;
      }
      form.style.display = 'none';
      feedbacksList.style.display = 'none';
      feedbackNavigation.style.display = 'none';
      const existingView = container.querySelector('.feedback-view');
      if (existingView) {
        existingView.remove();
      }
      let html = `
        <div class="feedback-view">
          <h3>–í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ</h3>
          <p><strong>–¢–∏–ø:</strong> ${escapeHtml(data.type)}</p>
          <p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong><br>${escapeHtml(data.message)}</p>
      `;

      if (data.admin_reply) {
        html += `
          <hr>
          <h3>–û—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
          <div class="admin-reply">
            ${escapeHtml(data.admin_reply)}
          </div>
        `;
      } else {
        html += '<p><em>–û—Ç–≤–µ—Ç –ø–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω</em></p>';
      }

      if (data.files && data.files.length > 0) {
        html += `
          <hr>
          <h3>–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h3>
          <div class="feedback-files">
        `;
        
        data.files.forEach(file => {
          let fileName, fileUrl;
          
          if (typeof file === 'string') {
            fileName = file.split('/').pop();
            fileUrl = file;
          } else if (file && typeof file === 'object') {
            fileName = file.name || (file.url ? file.url.split('/').pop() : '–§–∞–π–ª');
            fileUrl = file.url || file.path || file;
          } else {
            fileName = '–§–∞–π–ª';
            fileUrl = '#';
          }
          
          html += `
            <div class="feedback-file">
              <a href="${fileUrl}" target="_blank" download="${fileName}">
                üìé ${escapeHtml(fileName)}
              </a>
            </div>
          `;
        });
        
        html += '</div>';
      }
      html += `
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button id="backToFormBtn" class="button">–ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>
          <button id="backToListBtn" class="button">–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</button>
        </div>
      </div>
      `;

      const view = document.createElement('div');
      view.innerHTML = html;
      container.appendChild(view);

      document.getElementById('backToFormBtn').addEventListener('click', showForm);
      document.getElementById('backToListBtn').addEventListener('click', loadMyFeedbacks);
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', err);
      showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ: ' + err.message);
      showForm();
    }
  }
  newFeedbackBtn.addEventListener('click', showForm);
  myFeedbacksBtn.addEventListener('click', loadMyFeedbacks);

  fetch('/api/me.php')
    .then(r => {
      if (r.ok) {
        return r.json().then(user => {
          if (user) {
            myFeedbacksBtn.style.display = 'inline-block';
          }
        });
      }
    })
    .catch(() => {
    });

  if (feedbackId) {
    loadFeedback(feedbackId);
  } else {
    showForm();
  }
});
</script>


<script>
function showAlert(message, type = 'info', title = null, duration = 10000) {
  const alertId = 'alert-' + Date.now();
  const alert = document.createElement('div');
  alert.id = alertId;
  alert.className = `alert alert-${type}`;
  
  const icons = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  alert.innerHTML = `
    <div class="alert-icon">${icons[type] || icons.info}</div>
    <div class="alert-content">
      ${title ? `<div class="alert-title">${title}</div>` : ''}
      <div class="alert-message">${message}</div>
    </div>
    <button class="alert-close" onclick="closeAlert('${alertId}')">√ó</button>
  `;
  
  document.body.appendChild(alert);
  
  setTimeout(() => {
    alert.classList.add('show');
  }, 5000);
  
  const existingAlerts = document.querySelectorAll('.alert.show');
  existingAlerts.forEach((existingAlert, index) => {
    if (index > 0) {
      const translateY = (index + 1) * 10;
      existingAlert.style.transform = `translateY(${translateY}px)`;
    }
  });
  
  let timeoutId;
  if (duration > 1000) {
    timeoutId = setTimeout(() => {
      closeAlert(alertId);
    }, duration);
  }
  
  alert.dataset.timeoutId = timeoutId;
  
  alert.addEventListener('mouseenter', () => {
    if (timeoutId) {
      clearTimeout(timeoutId);
      alert.dataset.paused = 'true';
    }
  });
  
  alert.addEventListener('mouseleave', () => {
    if (alert.dataset.paused === 'true' && duration > 0) {
      timeoutId = setTimeout(() => {
        closeAlert(alertId);
      }, 3000); 
      alert.dataset.timeoutId = timeoutId;
      delete alert.dataset.paused;
    }
  });
  
  return alertId;
}

function closeAlert(alertId) {
  const alert = document.getElementById(alertId);
  if (!alert) return;
  
  if (alert.dataset.timeoutId) {
    clearTimeout(parseInt(alert.dataset.timeoutId));
  }
  
  alert.classList.remove('show');
  alert.classList.add('hiding');
  
  setTimeout(() => {
    if (alert.parentNode) {
      alert.remove();
      
      const remainingAlerts = document.querySelectorAll('.alert.show');
      remainingAlerts.forEach((alert, index) => {
        const translateY = index * 10;
        alert.style.transform = `translateY(${translateY}px)`;
      });
    }
  }, 800); 
}

window.originalAlert = window.alert;
window.alert = function(message, type = 'info') {
  showAlert(message, type === 'error' ? 'error' : 'info', '', 1000000);
};

function showSuccess(message, title = '–£—Å–ø–µ—à–Ω–æ') {
  return showAlert(message, 'success', title, 1000000); 
}

function showError(message, title = '–û—à–∏–±–∫–∞') {
  return showAlert(message, 'error', title, 1000000); 
}

function showWarning(message, title = '–í–Ω–∏–º–∞–Ω–∏–µ') {
  return showAlert(message, 'warning', title, 1000000); 
}

function showInfo(message, title = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è') {
  return showAlert(message, 'info', title, 1000000); 
}
</script>


</body>
</html>