<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</title>
  <link rel="stylesheet" href="/style.css">
  <script src="/js/init-landing.js" defer></script>
  <style>
    .zones-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
      cursor: pointer;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card.total {
      border-left: 4px solid #2196F3;
    }
    
    .stat-card.admins {
      border-left: 4px solid #E53935;
    }
    
    .stat-card.users {
      border-left: 4px solid #43A047;
    }
    
    .stat-card.no-yard {
      border-left: 4px solid #FBC02D;
    }
    
    .stat-card.today {
      border-left: 4px solid #9C27B0;
    }
    
    .stat-card.verified {
      border-left: 4px solid #00BCD4;
    }
    
    .stat-card.with-nickname {
      border-left: 4px solid #FF9800;
    }
    
    .stat-number {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .stat-label {
      font-size: 14px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-details {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }
    body {
      background: #f5f7fa;
      min-height: 100vh;
      overflow: hidden;
    }
    
    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 100px 20px 40px;
      min-height: calc(100vh - 70px);
    }
    
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      position: sticky;
      top: 0;
      background: #f5f7fa;
      z-index: 10;
      padding-top: 20px;
      padding-bottom: 15px;
    }
    
    
    .admin-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .admin-table th {
      background: #F7FAFC;
      padding: 16px 20px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      color: #4A5568;
      border-bottom: 1px solid #E2E8F0;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    
    .admin-table td {
      padding: 20px;
      border-bottom: 1px solid #E2E8F0;
      font-size: 15px;
      color: #2D3748;
    }
    
    .admin-table tr:hover {
      background: #F7FAFC;
    }
    
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #E53935;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-right: 12px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
    }
    
    .role-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .role-admin {
      background: #FED7D7;
      color: #C53030;
    }
    
    .role-user {
      background: #BEE3F8;
      color: #2C5282;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #718096;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #A0AEC0;
    }
    
    .filters {
      background: white;
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid #E2E8F0;
      background: white;
      color: #4A5568;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .filter-btn:hover {
      background: #F7FAFC;
    }
    
    .filter-btn.active {
      background: #E53935;
      color: white;
      border-color: #E53935;
    }
  </style>
</head>
<body>
<div id="adminHeader"></div>

<script>
fetch('header-admin.html')
  .then(r => r.text())
  .then(html => {
    document.getElementById('adminHeader').innerHTML = html;
    initAdminHeader('users');
  });
</script>

<div class="admin-container">
  <div class="zones-stats" id="usersStats">
    <div class="stat-card total" onclick="filterUsers('all')">
      <div class="stat-number" id="totalUsers">0</div>
      <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
      <div class="stat-details">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ —Å–∏—Å—Ç–µ–º–µ</div>
    </div>
    <div class="stat-card admins" onclick="filterUsers('admin')">
      <div class="stat-number" id="adminUsers">0</div>
      <div class="stat-label">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</div>
      <div class="stat-details">–ü—Ä–∞–≤–∞ –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
    </div>
    <div class="stat-card users" onclick="filterUsers('user')">
      <div class="stat-number" id="regularUsers">0</div>
      <div class="stat-label">–û–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
      <div class="stat-details">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ä–æ–ª—å</div>
    </div>
    <div class="stat-card no-yard" onclick="filterUsers('no-yard')">
      <div class="stat-number" id="usersWithoutYard">0</div>
      <div class="stat-label">–ë–µ–∑ –¥–≤–æ—Ä–∞</div>
      <div class="stat-details">–ù–µ –≤—ã–±—Ä–∞–ª–∏ –¥–≤–æ—Ä</div>
    </div>
    <div class="stat-card today" onclick="filterUsers('today')">
      <div class="stat-number" id="usersToday">0</div>
      <div class="stat-label">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
      <div class="stat-details">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞</div>
    </div>
    <div class="stat-card with-nickname" onclick="filterUsers('with-nickname')">
      <div class="stat-number" id="usersWithNickname">0</div>
      <div class="stat-label">–° –Ω–∏–∫–æ–º</div>
      <div class="stat-details">–£–∫–∞–∑–∞–ª–∏ –Ω–∏–∫–Ω–µ–π–º</div>
    </div>
  </div>
  <div class="filters">
    <span style="font-weight: 500; color: #4A5568;">–§–∏–ª—å—Ç—Ä—ã:</span>
    <button class="filter-btn active" onclick="filterUsers('all')">–í—Å–µ</button>
    <button class="filter-btn" onclick="filterUsers('admin')">–ê–¥–º–∏–Ω—ã</button>
    <button class="filter-btn" onclick="filterUsers('user')">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
    <button class="filter-btn" onclick="filterUsers('no-yard')">–ë–µ–∑ –¥–≤–æ—Ä–∞</button>
    <button class="filter-btn" onclick="filterUsers('today')">–°–µ–≥–æ–¥–Ω—è</button>
    <button class="filter-btn" onclick="showActivityView()">
      üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    </button>

    <input id="activityEmailFilter" class="filter-btn" style="border-radius:10px; min-width:220px; display:none;"
       placeholder="–ü–æ–∏—Å–∫ –ø–æ email..." oninput="applyActivityFilters()" />

    <input id="activityFrom" type="date" class="filter-btn" style="border-radius:10px; display:none;"
          onchange="applyActivityFilters()" />

    <input id="activityTo" type="date" class="filter-btn" style="border-radius:10px; display:none;"
          onchange="applyActivityFilters()" />

    <button id="activityBackBtn" class="filter-btn" style="display:none;" onclick="showUsersView()">
      ‚Üê –ù–∞–∑–∞–¥ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
    </button>



  </div>
  <div class="admin-table-wrapper">
    <table class="admin-table">
      <thead id="usersThead">
        <tr>
          <th>ID</th>
          <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
          <th>Email</th>
          <th>–ê–¥—Ä–µ—Å</th>
          <th>–î–≤–æ—Ä</th>
          <th>–†–æ–ª—å</th>
          <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
        </tr>
      </thead>
      <tbody id="users">
        <tr>
          <td colspan="8" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  let viewMode = 'users'; 

const USERS_THEAD_HTML = `
  <tr>
    <th>ID</th>
    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
    <th>Email</th>
    <th>–ê–¥—Ä–µ—Å</th>
    <th>–î–≤–æ—Ä</th>
    <th>–†–æ–ª—å</th>
    <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
  </tr>
`;

const ACTIVITY_THEAD_HTML = `
  <tr>
    <th>Email</th>
    <th>–°–æ–∑–¥–∞–Ω–æ –∑–æ–Ω</th>
    <th>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –∑–æ–Ω</th>
    <th>–ò—Ç–æ–≥–æ</th>
  </tr>
`;


function setThead(html) {
  document.getElementById('usersThead').innerHTML = html;
}

function renderActivity(rows) {
  const tbody = document.getElementById('users');

  if (!rows || rows.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = rows.map(r => {
    const created = Number(r.created_count) || 0;
    const confirmed = Number(r.confirmed_count) || 0;
    const total = created + confirmed;

    return `
      <tr>
        <td>
          <a href="mailto:${r.email}" style="color:#E53935;">
            ${r.email}
          </a>
        </td>
        <td>${created}</td>
        <td>${confirmed}</td>
        <td><strong>${total}</strong></td>
      </tr>
    `;
  }).join('');
}



function loadUsersActivity(queryString = '') {
  return fetch('/api/admin/users_activity.php' + queryString)
    .then(async r => {
      if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: ' + r.status);

      const text = await r.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON: ' + text.slice(0, 200));
      }
    });
}


function applyActivityFilters() {
  const q = (document.getElementById('activityEmailFilter').value || '').trim().toLowerCase();

  activityFiltered = activityRows.filter(r => {
    if (!q) return true;
    return String(r.email || '').toLowerCase().includes(q);
  });

  renderActivity(activityFiltered);
}


function showUsersView() {
  viewMode = 'users';
  setThead(USERS_THEAD_HTML);
  document.getElementById('activityEmailFilter').style.display = 'none';
  document.getElementById('activityFrom').style.display = 'none';
  document.getElementById('activityTo').style.display = 'none';
  document.getElementById('activityBackBtn').style.display = 'none';

  filterUsers(currentFilter);
}


function showActivityView() {
  viewMode = 'activity';
  setThead(ACTIVITY_THEAD_HTML);
  document.getElementById('activityEmailFilter').style.display = 'inline-block';
  document.getElementById('activityBackBtn').style.display = 'inline-block';
  document.getElementById('activityFrom').style.display = 'none';
  document.getElementById('activityTo').style.display = 'none';

  const tbody = document.getElementById('users');
  tbody.innerHTML = `
    <tr><td colspan="4" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...</td></tr>
  `;

  loadUsersActivity()
    .then(rows => {
      activityRows = rows;
      applyActivityFilters();
    })
    .catch(err => {
      console.error(err);
      tbody.innerHTML = `
        <tr>
          <td colspan="4" style="text-align:center; color:#C53030; padding:40px;">
            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏<br>
            <small>${String(err.message || err)}</small>
          </td>
        </tr>
      `;
    });
}

let allUsers = [];
let activityRows = [];
let activityFiltered = [];
let currentFilter = 'all';

function initAdminHeader(activeAdminPage) {
  fetch('/api/me.php')
    .then(r => {
      if (!r.ok) throw new Error();
      return r.json();
    })
    .then(user => {
      const greeting = getGreeting();
      
      const navHTML = `
        <span class="greeting">${greeting}, ${user.nickname || user.email}</span>
        
        <a href="/index.html" class="nav-link">–ö–∞—Ä—Ç–∞</a>
        
        <a href="/notifications.html" class="nav-link">
          –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
          ${user.unread_notifications > 0 ? `
            <span class="notif-badge">${user.unread_notifications}</span>
          ` : ''}
        </a>
        
        <a href="/feedback.html" class="nav-link">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</a>
        
        <a href="/profile.html" class="nav-link">–ü—Ä–æ—Ñ–∏–ª—å</a>

        <div class="admin-dropdown">
          <button class="admin-dropbtn">
            –ê–¥–º–∏–Ω
            <span class="admin-badge">‚öôÔ∏è</span>
          </button>
          <div class="admin-dropdown-content">
            <a href="/admin/zones.html" class="${activeAdminPage === 'zones' ? 'active' : ''}">–ó–æ–Ω—ã —Ä–µ–º–æ–Ω—Ç–∞</a>
            <a href="/admin/users.html" class="${activeAdminPage === 'users' ? 'active' : ''}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="/admin/feedback.html" class="${activeAdminPage === 'feedback' ? 'active' : ''}">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</a>
            <a href="/admin/broadcast.html" class="${activeAdminPage === 'broadcast' ? 'active' : ''}">–†–∞—Å—Å—ã–ª–∫–∞</a>
          </div>
        </div>
        
        <a href="/api/logout.php" class="nav-link">–í—ã—Ö–æ–¥</a>
      `;
      
      document.getElementById('nav').innerHTML = navHTML;
    })
    .catch(() => {
      window.location.href = '/login.html';
    });
}

function getGreeting() {
  const hour = new Date().getHours();
  if (hour >= 5 && hour < 12) return '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ';
  if (hour >= 12 && hour < 17) return '–î–æ–±—Ä—ã–π –¥–µ–Ω—å';
  if (hour >= 17 && hour < 23) return '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä';
  return '–î–æ–±—Ä–æ–π –Ω–æ—á–∏';
}

function loadUsers() {
  return fetch('/api/admin/users.php')
    .then(async r => {
      if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + r.status);
      const text = await r.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON: ' + text.slice(0, 200));
      }
    })
    .then(users => {
      allUsers = users;
      renderUsers(users);
      return users;
    })
    .catch(err => {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', err);
      const tbody = document.getElementById('users');
      tbody.innerHTML = `
        <tr>
          <td colspan="8" style="text-align: center; color: #C53030; padding: 40px;">
            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö<br>
            <small>${String(err.message || err)}</small>
          </td>
        </tr>
      `;
      throw err;
    });
}



function renderUsers(users) {
  const tbody = document.getElementById('users');
  
  if (!users || users.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8" class="empty-state">
          üë• –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        </td>
      </tr>
    `;
    return;
  }

  let html = '';
  users.forEach(u => {
    const initials = (u.nickname || u.email).charAt(0).toUpperCase();
    const roleClass = u.role === 'admin' ? 'role-admin' : 'role-user';
    const roleText = u.role === 'admin' ? '–ê–¥–º–∏–Ω' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    
    html += `
      <tr>
        <td><strong>#${u.id}</strong></td>
        <td>
          <div class="user-info">
            <div class="user-avatar">${initials}</div>
            <div>
              <div style="font-weight: 500;">${u.nickname || '‚Äî'}</div>
              <div style="font-size: 13px; color: #718096;">
                ID: ${u.id}
              </div>
            </div>
          </div>
        </td>
        <td>
          <a href="mailto:${u.email}" style="color: #E53935;">
            ${u.email}
          </a>
        </td>
        <td>${u.address || '‚Äî'}</td>
        <td>${u.yard_id || '‚Äî'}</td>
        <td>
          <span class="role-badge ${roleClass}">
            ${roleText}
          </span>
        </td>
        <td title="${new Date(u.created_at).toLocaleString('ru-RU')}">
          ${new Date(u.created_at).toLocaleDateString('ru-RU')}<br>
          <small style="color: #718096;">${new Date(u.created_at).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</small>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function filterUsers(filterType) {
  if (viewMode !== 'users') {
    setThead(USERS_THEAD_HTML);
    viewMode = 'users';
  }

  currentFilter = filterType;
  
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector(`.filter-btn[onclick*="${filterType}"]`)?.classList.add('active');
  
  let filteredUsers = [];
  
  switch(filterType) {
    case 'all':
      filteredUsers = allUsers;
      break;
      
    case 'admin':
      filteredUsers = allUsers.filter(u => u.role === 'admin');
      break;
      
    case 'user':
      filteredUsers = allUsers.filter(u => u.role === 'user');
      break;
      
    case 'no-yard':
      filteredUsers = allUsers.filter(u => !u.yard_id || u.yard_id === '');
      break;
      
    case 'today':
      const today = new Date().toISOString().split('T')[0];
      filteredUsers = allUsers.filter(u => u.created_at.startsWith(today));
      break;
      
    case 'with-nickname':
      filteredUsers = allUsers.filter(u => u.nickname && u.nickname.trim() !== '');
      break;
      
    default:
      filteredUsers = allUsers;
  }
  
  renderUsers(filteredUsers);
}

function loadUsersStats() {
  fetch('/api/admin/users_stats.php')
    .then(r => {
      if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
      return r.json();
    })
    .then(stats => {
      document.getElementById('totalUsers').textContent = stats.total_users || 0;
      document.getElementById('adminUsers').textContent = stats.admin_users || 0;
      document.getElementById('regularUsers').textContent = stats.regular_users || 0;
      document.getElementById('usersWithoutYard').textContent = stats.users_without_yard || 0;
      document.getElementById('usersToday').textContent = stats.users_today || 0;
      document.getElementById('usersWithNickname').textContent = stats.users_with_nickname || 0;
    })
    .catch(err => console.error('–û—à–∏–±–∫–∞ loadUsersStats:', err));
}

document.addEventListener('DOMContentLoaded', function() {
  loadUsersStats();
  loadUsers();
  
  setInterval(function() {
    loadUsersStats();

    if (viewMode === 'users') {
      loadUsers().then(() => filterUsers(currentFilter));
    } else {
      showActivityView();
    }
  }, 60000);

});

document.addEventListener('DOMContentLoaded', function() {
  function showLandingCard() {
    window.location.href = '/index.html';
  }
  
  const logos = document.querySelectorAll('.logo');
  logos.forEach(logo => {
    logo.style.cursor = 'pointer';
    logo.title = '–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≥–ª–∞–≤–Ω—É—é';
    logo.addEventListener('click', function(e) {
      e.preventDefault();
      showLandingCard();
    });
  });
});
</script>
</body>
</html>