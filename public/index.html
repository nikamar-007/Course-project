<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–µ –ø–µ—à–µ—Ö–æ–¥–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã</title>

  <link rel="stylesheet" href="style.css">
  <script src="js/init-landing.js" defer></script>
  <script src="https://api-maps.yandex.ru/2.1/?apikey=9f0428a7-7d03-4225-b272-0d138349ff59&lang=ru_RU" type="text/javascript"></script>
</head>
<body>
<div class="map-container">
  <div id="map"></div>
</div>

<div id="landingCardContainer"></div>
<script>
  fetch('/landing-card.html')
    .then(r => r.text())
    .then(html => {
      document.getElementById('landingCardContainer').innerHTML = html;
    });
</script>

<div id="header"></div>
<script>
fetch('/header.html')
  .then(r => r.text())
  .then(html => {
    document.getElementById('header').innerHTML = html;
    initHeader('map'); 
  });
</script>

<script>
function getGreeting() {
  const hour = new Date().getHours();
  if (hour >= 5 && hour < 12) return '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ';
  if (hour >= 12 && hour < 17) return '–î–æ–±—Ä—ã–π –¥–µ–Ω—å';
  if (hour >= 17 && hour < 23) return '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä';
  return '–î–æ–±—Ä–æ–π –Ω–æ—á–∏';
}

function initHeader(activePage) {
  console.log('initHeader: –Ω–∞—á–∞–ª–æ');
  fetch('/api/me.php')
    .then(r => {
      console.log('Auth status:', r.status);
      if (r.status === 401) {
        throw new Error('Not authenticated');
      }
      if (!r.ok) throw new Error('Server error');
      return r.json();
    })
    .then(user => {
      console.log('User data:', user);
      const greeting = getGreeting();

      let adminLinks = '';
      if (user.role === 'admin') {
        adminLinks = `
          <div class="admin-dropdown">
            <button class="admin-dropbtn">
              –ê–¥–º–∏–Ω
              <span class="admin-badge">‚öôÔ∏è</span>
            </button>
            <div class="admin-dropdown-content">
              <a href="/admin/zones.html" class="nav-link">–ó–æ–Ω—ã —Ä–µ–º–æ–Ω—Ç–∞</a>
              <a href="/admin/users.html" class="nav-link">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
              <a href="/admin/feedback.html" class="nav-link">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</a>
              <a href="/admin/broadcast.html" class="nav-link">–†–∞—Å—Å—ã–ª–∫–∞</a>
            </div>
          </div>
        `;
      }

      const avatarPath = user.avatar_path ? 
        (user.avatar_path.startsWith('http') ? user.avatar_path : location.origin + user.avatar_path) :
        '/uploads/avatars/Sun.jpg'
      const nav = document.getElementById('nav');
      if (!nav.dataset.initialized) {
        nav.innerHTML = `
          <div class="user-profile-header">
            <img id="headerAvatar"
                src="/uploads/avatars/Sun.jpg"
                alt=""
                class="user-avatar">
            <span id="headerGreeting" class="greeting"></span>
          </div>
          <a href="/index.html" class="nav-link ${activePage === 'map' ? 'active' : ''}">
            –ö–∞—Ä—Ç–∞
          </a>
          <a href="/notifications.html" class="nav-link ${activePage === 'notifications' ? 'active' : ''}">
            –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
          </a>
          <a href="/feedback.html" class="nav-link">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</a>
          <a href="/profile.html" class="nav-link ${activePage === 'profile' ? 'active' : ''}">
            –ü—Ä–æ—Ñ–∏–ª—å
          </a>
          ${adminLinks}

          <a href="/api/logout.php" class="nav-link">–í—ã—Ö–æ–¥</a>
        `;
        nav.dataset.initialized = '1';
      }

      const avatarImg = document.getElementById('headerAvatar');
      const greetingEl = document.getElementById('headerGreeting');

      greetingEl.textContent = `${greeting}, ${user.nickname || user.email}`;

      const PLACEHOLDER = '/uploads/avatars/Sun.jpg';
      let newSrc = PLACEHOLDER;

      if (user.avatar_path && user.avatar_path.trim() !== '') {
        newSrc = user.avatar_path.startsWith('http')
          ? user.avatar_path
          : location.origin + user.avatar_path;
      }
      if (avatarImg.getAttribute('src') !== newSrc) {
        avatarImg.setAttribute('src', newSrc);
      }

      avatarImg.onerror = () => {
        if (avatarImg.dataset.fallback) return;
        avatarImg.dataset.fallback = '1';
        avatarImg.src = PLACEHOLDER;
      };

      
      isAuthenticated = true;
      window.userData = user;
      console.log('initHeader: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
      checkAndShowHomeButton();
    })
    .catch((error) => {
      console.log('initHeader: –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω', error);
      document.getElementById('nav').innerHTML = `
        <a href="/index.html" class="nav-link ${activePage === 'map' ? 'active' : ''}">
          –ö–∞—Ä—Ç–∞
        </a>
        <a href="/login.html" class="nav-link">–í—Ö–æ–¥</a>
        <a href="/register.html" class="nav-link">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
      `;
      isAuthenticated = false;
      window.userData = null;
      console.log('initHeader: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º');
      checkAndShowHomeButton();
    })
    .finally(() => {
      console.log('initHeader: –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
    });
}
</script>
  
<button id="openPanelBtn">‚ò∞</button>
  
<button id="myHomeBtn" class="my-home-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å –º–æ–π –¥–æ–º –Ω–∞ –∫–∞—Ä—Ç–µ">
  <span style="font-size: 12px; margin-right: 3px;">üè†</span> –ú–æ–π –¥–æ–º
</button>
<div class="panel">
  <div class="panel-header">
    <span class="panel-title">–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–µ—à–µ—Ö–æ–¥–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞</span>
    <button class="close-btn" id="btnClosePanel">√ó</button>
  </div>

  <div class="mode-selector">
    <button id="btnSimpleRoute" class="mode-btn active">–ü—Ä–æ—Å—Ç–æ–π –º–∞—Ä—à—Ä—É—Ç</button>
    <button id="btnCustomRoute" class="mode-btn">–†—É—á–Ω–æ–π –æ–±—Ö–æ–¥</button>
  </div>
  <div id="simpleRoutePanel">
    <label>–¢–æ—á–∫–∞ –ê (–Ω–∞—á–∞–ª–æ)</label>
    <input id="addrA" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ" />

    <label>–¢–æ—á–∫–∞ B (–∫–æ–Ω–µ—Ü)</label>
    <input id="addrB" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ" />

    <div class="actions">
      <button id="btnRoute">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
      <button id="btnClear" class="btn-yellow">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    
    <div id="routeStats" class="route-stats" style="display: none;">
      <div class="stat-item">
        <div class="stat-value" id="routeDistance">0 –∫–º</div>
        <div class="stat-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="routeDuration">0 –º–∏–Ω</div>
        <div class="stat-label">–í—Ä–µ–º—è</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="routeElevation">¬±0 –º</div>
        <div class="stat-label">–ü–µ—Ä–µ–ø–∞–¥ –≤—ã—Å–æ—Ç</div>
      </div>
    </div>
    
    <div id="routeWarning" class="route-warning" style="display: none;">
      <div class="warning-header">
        ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ù–∞ –ø—É—Ç–∏ –µ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç–Ω—ã–µ –∑–æ–Ω—ã
      </div>
      <div class="warning-content" id="warningContent">
        –ú–∞—Ä—à—Ä—É—Ç –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç —Ä–µ–º–æ–Ω—Ç–Ω—ã–µ –∑–æ–Ω—ã. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—É–¥–æ–±–Ω–æ –∏ –æ–ø–∞—Å–Ω–æ.
      </div>
      <div class="warning-actions">
        <button id="btnSwitchToManual" class="warning-btn warning-btn-primary">
          üó∫Ô∏è –û–±–æ–π—Ç–∏ –≤—Ä—É—á–Ω—É—é
        </button>
        <button id="btnContinueAnyway" class="warning-btn warning-btn-secondary">
          ‚ö° –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å
        </button>
      </div>
    </div>
    
    <div id="elevationChart" style="display: none; margin-top: 20px;">
      <canvas id="elevationCanvas" width="400" height="150"></canvas>
    </div>
  </div>
  <div id="customRoutePanel" style="display: none;">
    <div class="instructions">
      <p>1. –ù–∞—á–Ω–∏—Ç–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</p>
      <p>2. –ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –æ–±—Ö–æ–¥–∞</p>
      <p>3. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ, —á—Ç–æ –º–∞—Ä—à—Ä—É—Ç –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –∑–æ–Ω—ã</p>
    </div>

    <div class="actions">
      <button id="btnStartManualRoute" class="btn-primary">
        üó∫Ô∏è –ù–∞—á–∞—Ç—å —Ä—É—á–Ω–æ–π –æ–±—Ö–æ–¥
      </button>
      <button id="btnCheckRoute" class="btn-yellow" disabled>
        üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç
      </button>
      <button id="btnClearManualRoute" class="btn-yellow">
        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
      </button>
    </div>

    <div class="route-points-list">
      <h4>–¢–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞:</h4>
      <div id="manualPointsList"></div>
    </div>
    
    <div id="manualRouteStats" class="route-stats" style="display: none;">
      <div class="stat-item">
        <div class="stat-value" id="manualRouteDistance">0 –∫–º</div>
        <div class="stat-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="manualRouteDuration">0 –º–∏–Ω</div>
        <div class="stat-label">–í—Ä–µ–º—è</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="manualRouteElevation">¬±0 –º</div>
        <div class="stat-label">–ü–µ—Ä–µ–ø–∞–¥ –≤—ã—Å–æ—Ç</div>
      </div>
    </div>
    
    <div id="manualRouteWarning" class="route-warning" style="display: none;">
      <div class="warning-header">
        ‚ö†Ô∏è –ú–∞—Ä—à—Ä—É—Ç –≤—Å–µ –µ—â–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –∑–æ–Ω—ã
      </div>
      <div class="warning-content" id="manualWarningContent">
        –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ —Ç–æ—á–µ–∫ –æ–±—Ö–æ–¥–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–µ–º–æ–Ω—Ç–Ω—ã—Ö –∑–æ–Ω.
      </div>
      <div class="warning-actions">
        <button id="btnAddMorePoints" class="warning-btn warning-btn-primary">
          ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫–∏ –æ–±—Ö–æ–¥–∞
        </button>
        <button id="btnFinishManualRoute" class="warning-btn warning-btn-secondary">
          ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –∑–æ–Ω—ã
        </button>
      </div>
    </div>
    
    <div id="manualElevationChart" style="display: none; margin-top: 20px;">
      <canvas id="manualElevationCanvas" width="400" height="150"></canvas>
    </div>
  </div>

  <button id="btnDrawZone" class="btn-zone">–û—Ç–º–µ—Ç–∏—Ç—å –∑–æ–Ω—É —Ä–µ–º–æ–Ω—Ç–∞</button>

  <div id="status">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞</div>

  <div id="zoneForm" style="display:none; margin-top:20px;">
    <label>–û–ø–∏—Å–∞–Ω–∏–µ –∑–æ–Ω—ã —Ä–µ–º–æ–Ω—Ç–∞</label>
    <textarea id="zoneDescription" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É..."></textarea>
    <div class="actions">
      <button id="btnSaveZone">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–æ–Ω—É</button>
      <button id="btnCancelZone" class="btn-yellow">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<script>
let isAuthenticated = false;
let userHomePlacemark = null;
let map, multiRouter;
let pointA = null, pointB = null;
let currentPolygon = null;
let routeCheckInterval = null;
let elevationChart = null;
let manualElevationChart = null;
let manualRoutePoints = [];
let isManualModeActive = false;
let manualPlacemarks = [];
let manualRoutePolyline = null;
let manualRouteYandexRouter = null;
ymaps.ready(init);

function init() {
  window.tempClickPlacemark = null;
  map = new ymaps.Map('map', {
    center: [55.7558, 37.6173],
    zoom: 12,
    controls: ['zoomControl', 'geolocationControl', 'typeSelector', 'fullscreenControl']
  });

  let mode = 'A';
  map.events.add('click', (e) => {
    const coords = e.get('coords');

    if (isManualModeActive) {
      handleManualPointClick(e);
      return;
    }

    if (mode === 'zone' && currentPolygon) {
      currentPolygon.geometry.getCoordinates()[0].push(coords);
      currentPolygon.update();
      return;
    }

    if (window.tempClickPlacemark) {
      map.geoObjects.remove(window.tempClickPlacemark);
    }

    window.tempClickPlacemark = new ymaps.Placemark(coords, {}, {
      preset: 'islands#blueCircleIcon',
      iconColor: '#1e88e5'
    });
    map.geoObjects.add(window.tempClickPlacemark);

    reverseGeocode(coords, (address) => {
      if (mode === 'A') {
        setPoint('A', coords, address);
        mode = 'B';
      } else if (mode === 'B') {
        setPoint('B', coords, address);
        mode = 'A';
      }
      
      if (window.tempClickPlacemark) {
        map.geoObjects.remove(window.tempClickPlacemark);
        window.tempClickPlacemark = null;
      }
    });
  });
  document.getElementById('btnSimpleRoute').onclick = () => {
    document.getElementById('simpleRoutePanel').style.display = 'block';
    document.getElementById('customRoutePanel').style.display = 'none';
    document.getElementById('btnSimpleRoute').classList.add('active');
    document.getElementById('btnCustomRoute').classList.remove('active');
    isManualModeActive = false;
    updateStatus('–†–µ–∂–∏–º: –ø—Ä–æ—Å—Ç–æ–π –º–∞—Ä—à—Ä—É—Ç');
    clearManualRoute();
  };
  
  document.getElementById('btnCustomRoute').onclick = () => {
    document.getElementById('simpleRoutePanel').style.display = 'none';
    document.getElementById('customRoutePanel').style.display = 'block';
    document.getElementById('btnSimpleRoute').classList.remove('active');
    document.getElementById('btnCustomRoute').classList.add('active');
    updateStatus('–†–µ–∂–∏–º: —Ä—É—á–Ω–æ–π –æ–±—Ö–æ–¥. –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å —Ä—É—á–Ω–æ–π –æ–±—Ö–æ–¥"');
    clearRouteVisuals();
  };
  document.getElementById('btnRoute').onclick = buildSimpleRoute;
  document.getElementById('btnClear').onclick = clearAll;
  document.getElementById('btnSwitchToManual').onclick = switchToManualMode;
  document.getElementById('btnContinueAnyway').onclick = continueAnyway;
  document.getElementById('btnStartManualRoute').onclick = startManualRoute;
  document.getElementById('btnCheckRoute').onclick = checkManualRoute;
  document.getElementById('btnClearManualRoute').onclick = clearManualRoute;
  document.getElementById('btnAddMorePoints').onclick = () => {
    updateStatus('–ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –æ–±—Ö–æ–¥–∞');
  };
  document.getElementById('btnFinishManualRoute').onclick = finishManualRouteAnyway;
  document.getElementById('myHomeBtn').onclick = showMyHome;
  document.getElementById('btnDrawZone').onclick = startDrawingZone;
  document.getElementById('btnSaveZone').onclick = saveZone;
  document.getElementById('btnCancelZone').onclick = cancelZone;

  loadRepairZones();
  const openBtn = document.getElementById('openPanelBtn');
  const closeBtn = document.getElementById('btnClosePanel');
  const panel = document.querySelector('.panel');

  if (openBtn) {
    openBtn.style.display = 'none';
    openBtn.classList.add('hidden');
  }

  if (panel) {
    panel.classList.add('initialized');
  }

  if (openBtn && panel) {
    openBtn.addEventListener('click', () => {
      panel.classList.remove('hidden');
      panel.style.display = 'block';
      openBtn.style.display = 'none';
      openBtn.classList.add('hidden');
    });
  }

  if (closeBtn && panel) {
    closeBtn.addEventListener('click', () => {
      panel.classList.add('hidden');
      setTimeout(() => {
        panel.style.display = 'none';
        if (openBtn) {
          openBtn.style.display = 'flex';
          openBtn.classList.remove('hidden');
        }
      }, 300);
    });
  }
  initAddressSuggestions();
  checkAndShowHomeButton();
}
async function buildSimpleRoute() {
  console.log('–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞...');
  if (!pointA || !pointB) {
    updateStatus('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –æ–±–µ —Ç–æ—á–∫–∏!');
    showToast('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –æ–±–µ —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞!', true);
    return;
  }

  clearRouteVisuals();

  const start = pointA.geometry.getCoordinates();
  const end = pointB.geometry.getCoordinates();

  multiRouter = new ymaps.multiRouter.MultiRoute(
    {
      referencePoints: [start, end],
      params: { routingMode: 'pedestrian' }
    },
    { 
      boundsAutoApply: true,
      routeActiveStrokeWidth: 6,
      routeActiveStrokeColor: '#1e88e5',
      routeStrokeWidth: 4,
      routeStrokeColor: '#666666'
    }
  );

  map.geoObjects.add(multiRouter);

  multiRouter.model.events.add('requestsuccess', async () => {
    console.log('–ú–∞—Ä—à—Ä—É—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω');
    const route = multiRouter.getRoutes().get(0);
    const distance = route.properties.get('distance').text;
    const duration = route.properties.get('duration').text;

    document.getElementById('routeDistance').textContent = distance;
    document.getElementById('routeDuration').textContent = duration;
    document.getElementById('routeStats').style.display = 'flex';

    const routeGeoJSON = extractRouteGeoJSON(route);
    console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å —Ä–µ–º–æ–Ω—Ç–Ω—ã–º–∏ –∑–æ–Ω–∞–º–∏...');
    const checkResult = await checkRouteIntersects(routeGeoJSON);
    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:', checkResult);

    if (checkResult.intersects) {
      showRouteWarning(checkResult);
      updateStatus('‚ö†Ô∏è –ú–∞—Ä—à—Ä—É—Ç –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç —Ä–µ–º–æ–Ω—Ç–Ω—ã–µ –∑–æ–Ω—ã!');
    } else {
      hideRouteWarning();
      updateStatus(`–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω! ${distance}, ${duration}`);
      showElevationProfile(route, 'elevationCanvas', 'routeElevation');
    }
  });

  multiRouter.model.events.add('requesterror', () => {
    console.log('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞');
    updateStatus('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞');
  });
}

async function showElevationProfile(route, canvasId, elevationElementId) {
  try {
    const coords = [];
    const paths = route.getPaths();
    
    paths.each((path) => {
      const segments = path.getSegments();
      segments.each((segment) => {
        const segmentGeometry = segment.geometry;
        if (segmentGeometry && segmentGeometry.getCoordinates) {
          const segmentCoords = segmentGeometry.getCoordinates();
          if (segmentCoords && Array.isArray(segmentCoords)) {
            segmentCoords.forEach((coord) => {
              coords.push(coord);
            });
          }
        }
      });
    });
    const elevationData = generateMockElevationData(coords.length);
    
    document.getElementById(canvasId === 'elevationCanvas' ? 'elevationChart' : 'manualElevationChart').style.display = 'block';
    drawElevationChart(elevationData, canvasId);
    const elevationDiff = calculateElevationDiff(elevationData);
    document.getElementById(elevationElementId).textContent = `¬±${elevationDiff} –º`;
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –≤—ã—Å–æ—Ç:', error);
  }
}

function generateMockElevationData(count) {
  const data = [];
  let current = 120;
  
  for (let i = 0; i < count; i++) {
    current += (Math.random() - 0.5) * 10;
    data.push(Math.max(100, Math.min(150, current)));
  }
  
  return data;
}

function calculateElevationDiff(data) {
  if (data.length === 0) return 0;
  
  let min = data[0];
  let max = data[0];
  
  for (let i = 1; i < data.length; i++) {
    if (data[i] < min) min = data[i];
    if (data[i] > max) max = data[i];
  }
  
  return Math.round(max - min);
}

function drawElevationChart(data, canvasId) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const min = Math.min(...data);
  const max = Math.max(...data);
  const range = max - min || 1;
  ctx.beginPath();
  ctx.moveTo(20, canvas.height - 20);
  ctx.lineTo(canvas.width - 20, canvas.height - 20);
  ctx.strokeStyle = '#666';
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(20, 20);
  ctx.lineTo(20, canvas.height - 20);
  ctx.strokeStyle = '#666';
  ctx.stroke();
  ctx.beginPath();
  const stepX = (canvas.width - 40) / (data.length - 1);
  
  for (let i = 0; i < data.length; i++) {
    const x = 20 + i * stepX;
    const y = canvas.height - 20 - ((data[i] - min) / range) * (canvas.height - 40);
    
    if (i === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  }
  
  ctx.strokeStyle = '#1e88e5';
  ctx.lineWidth = 2;
  ctx.stroke();
  ctx.fillStyle = '#666';
  ctx.font = '10px Arial';
  ctx.fillText(`${min} –º`, 5, canvas.height - 15);
  ctx.fillText(`${max} –º`, 5, 25);
}

function showRouteWarning(checkResult) {
  const warningDiv = document.getElementById('routeWarning');
  const warningContent = document.getElementById('warningContent');
  
  warningContent.innerHTML = `
    <p>${checkResult.message}</p>
    <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π: <strong>${checkResult.count || 1}</strong></p>
    <p>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ–±–æ–π—Ç–∏ —ç—Ç–∏ –∑–æ–Ω—ã –¥–ª—è –≤–∞—à–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p>
  `;
  
  warningDiv.style.display = 'block';
}

function hideRouteWarning() {
  document.getElementById('routeWarning').style.display = 'none';
}

function switchToManualMode() {
  document.getElementById('btnCustomRoute').click();
  startManualRoute();
  
  hideRouteWarning();
  clearRouteVisuals();
  
  updateStatus('–†–µ–∂–∏–º —Ä—É—á–Ω–æ–≥–æ –æ–±—Ö–æ–¥–∞. –ù–∞—á–∞–ª—å–Ω–∞—è –∏ –∫–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –î–æ–±–∞–≤–ª—è–π—Ç–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏.');
}

function continueAnyway() {
  hideRouteWarning();
  updateStatus('–í—ã –ø—Ä–æ–¥–æ–ª–∂–∏–ª–∏ —á–µ—Ä–µ–∑ —Ä–µ–º–æ–Ω—Ç–Ω—ã–µ –∑–æ–Ω—ã. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã!');
  if (multiRouter) {
    const route = multiRouter.getRoutes().get(0);
    showElevationProfile(route, 'elevationCanvas', 'routeElevation');
  }
}
function startManualRoute() {
  if (!pointA || !pointB) {
    showToast('–°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫–∏ –≤ –ø—Ä–æ—Å—Ç–æ–º —Ä–µ–∂–∏–º–µ!', true);
    document.getElementById('btnSimpleRoute').click();
    return;
  }
  
  isManualModeActive = true;
  document.getElementById('btnCheckRoute').disabled = false;
  updateStatus('–ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –æ–±—Ö–æ–¥–∞');
  
  clearManualRoute();
  const startCoords = pointA.geometry.getCoordinates();
  const endCoords = pointB.geometry.getCoordinates();
  const startPlacemark = new ymaps.Placemark(startCoords, {
    balloonContent: '–ù–∞—á–∞–ª–æ –º–∞—Ä—à—Ä—É—Ç–∞'
  }, {
    preset: 'islands#redCircleDotIcon',
    draggable: false
  });
  
  const endPlacemark = new ymaps.Placemark(endCoords, {
    balloonContent: '–ö–æ–Ω–µ—Ü –º–∞—Ä—à—Ä—É—Ç–∞'
  }, {
    preset: 'islands#yellowCircleDotIcon',
    draggable: false
  });
  
  map.geoObjects.add(startPlacemark);
  map.geoObjects.add(endPlacemark);
  manualPlacemarks.push(startPlacemark, endPlacemark);
  reverseGeocode(startCoords, (startAddress) => {
    reverseGeocode(endCoords, (endAddress) => {
      manualRoutePoints = [
        { coords: startCoords, address: startAddress, type: 'start', placemark: startPlacemark },
        { coords: endCoords, address: endAddress, type: 'end', placemark: endPlacemark }
      ];
      
      updateManualPointsList();
      buildManualRouteYandex();
    });
  });
}

function handleManualPointClick(e) {
  if (!isManualModeActive) return;
  
  const coords = e.get('coords');
  
  reverseGeocode(coords, (address) => {
    const placemark = new ymaps.Placemark(coords, {
      balloonContent: `–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è —Ç–æ—á–∫–∞: ${address}`
    }, {
      preset: 'islands#blueCircleDotIcon',
      draggable: true
    });
    placemark.events.add('dragend', () => {
      const newCoords = placemark.geometry.getCoordinates();
      const pointIndex = manualRoutePoints.findIndex(p => p.placemark === placemark);
      if (pointIndex !== -1) {
        manualRoutePoints[pointIndex].coords = newCoords;
        reverseGeocode(newCoords, (newAddress) => {
          manualRoutePoints[pointIndex].address = newAddress;
          updateManualPointsList();
          buildManualRouteYandex();
        });
      }
    });
    
    map.geoObjects.add(placemark);
    manualPlacemarks.push(placemark);
    manualRoutePoints.splice(manualRoutePoints.length - 1, 0, {
      coords: coords,
      address: address,
      type: 'intermediate',
      id: Date.now(),
      placemark: placemark
    });
    
    updateManualPointsList();
    buildManualRouteYandex();
  });
}

function updateManualPointsList() {
  const list = document.getElementById('manualPointsList');
  list.innerHTML = '';
  
  manualRoutePoints.forEach((point, index) => {
    const pointElement = document.createElement('div');
    pointElement.className = 'point-item';
    
    let pointType = '';
    let icon = '';
    if (point.type === 'start') {
      pointType = 'üö© –ù–∞—á–∞–ª–æ';
      icon = 'üö©';
    } else if (point.type === 'end') {
      pointType = 'üèÅ –ö–æ–Ω–µ—Ü';
      icon = 'üèÅ';
    } else {
      pointType = `üìç –¢–æ—á–∫–∞ ${index - 1}`;
      icon = 'üìç';
    }
    
    pointElement.innerHTML = `
      <div>
        <strong>${icon} ${pointType}</strong>
        <div style="font-size: 12px; color: #666;">${point.address || '–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}</div>
      </div>
      <div class="point-actions">
        ${point.type === 'intermediate' ? `
          <button class="point-btn point-btn-up" onclick="movePointUp(${index})">‚Üë</button>
          <button class="point-btn point-btn-down" onclick="movePointDown(${index})">‚Üì</button>
          <button class="point-btn point-btn-remove" onclick="removeManualPoint(${index})">√ó</button>
        ` : ''}
      </div>
    `;
    list.appendChild(pointElement);
  });
}

function movePointUp(index) {
  if (index <= 1 || index >= manualRoutePoints.length - 1) return;
  
  const temp = manualRoutePoints[index];
  manualRoutePoints[index] = manualRoutePoints[index - 1];
  manualRoutePoints[index - 1] = temp;
  
  updateManualPointsList();
  buildManualRouteYandex();
}

function movePointDown(index) {
  if (index < 1 || index >= manualRoutePoints.length - 2) return;
  
  const temp = manualRoutePoints[index];
  manualRoutePoints[index] = manualRoutePoints[index + 1];
  manualRoutePoints[index + 1] = temp;
  
  updateManualPointsList();
  buildManualRouteYandex();
}

function removeManualPoint(index) {
  if (manualRoutePoints[index].type === 'intermediate') {
    if (manualRoutePoints[index].placemark) {
      map.geoObjects.remove(manualRoutePoints[index].placemark);
      const pmIndex = manualPlacemarks.indexOf(manualRoutePoints[index].placemark);
      if (pmIndex !== -1) {
        manualPlacemarks.splice(pmIndex, 1);
      }
    }
    
    manualRoutePoints.splice(index, 1);
    updateManualPointsList();
    buildManualRouteYandex();
  }
}

async function buildManualRouteYandex() {
  if (manualRoutePoints.length < 2) return;
  
  if (manualRouteYandexRouter) {
    map.geoObjects.remove(manualRouteYandexRouter);
    manualRouteYandexRouter = null;
  }
  
  const referencePoints = manualRoutePoints.map(p => p.coords);
  
  manualRouteYandexRouter = new ymaps.multiRouter.MultiRoute(
    {
      referencePoints: referencePoints,
      params: { routingMode: 'pedestrian' }
    },
    { 
      boundsAutoApply: true,
      routeActiveStrokeWidth: 6,
      routeActiveStrokeColor: '#4CAF50',
      routeStrokeWidth: 4,
      routeStrokeColor: '#388E3C'
    }
  );

  map.geoObjects.add(manualRouteYandexRouter);

  manualRouteYandexRouter.model.events.add('requestsuccess', async () => {
    const route = manualRouteYandexRouter.getRoutes().get(0);
    const distance = route.properties.get('distance').text;
    const duration = route.properties.get('duration').text;

    document.getElementById('manualRouteDistance').textContent = distance;
    document.getElementById('manualRouteDuration').textContent = duration;
    document.getElementById('manualRouteStats').style.display = 'flex';

    const routeGeoJSON = extractRouteGeoJSON(route);
    const checkResult = await checkRouteIntersects(routeGeoJSON);

    if (checkResult.intersects) {
      showManualRouteWarning(checkResult);
      updateStatus('‚ö†Ô∏è –†—É—á–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç —Ä–µ–º–æ–Ω—Ç–Ω—ã–µ –∑–æ–Ω—ã!');
    } else {
      hideManualRouteWarning();
      updateStatus(`–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä—É—á–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω! ${distance}, ${duration}`);
      
      showElevationProfile(route, 'manualElevationCanvas', 'manualRouteElevation');
    }
  });

  manualRouteYandexRouter.model.events.add('requesterror', () => {
    updateStatus('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Ä—É—á–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞');
  });
}

async function checkManualRoute() {
  if (!manualRouteYandexRouter) {
    updateStatus('–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—Ä–æ–π—Ç–µ —Ä—É—á–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç');
    return;
  }
  
  const route = manualRouteYandexRouter.getRoutes().get(0);
  const routeGeoJSON = extractRouteGeoJSON(route);
  const checkResult = await checkRouteIntersects(routeGeoJSON);
  
  if (checkResult.intersects) {
    showManualRouteWarning(checkResult);
  } else {
    hideManualRouteWarning();
    showToast('‚úÖ –ú–∞—Ä—à—Ä—É—Ç –±–µ–∑–æ–ø–∞—Å–µ–Ω!');
    updateStatus('–ú–∞—Ä—à—Ä—É—Ç –±–µ–∑–æ–ø–∞—Å–µ–Ω!');
  }
  
  return checkResult;
}

function showManualRouteWarning(checkResult) {
  const warningDiv = document.getElementById('manualRouteWarning');
  const warningContent = document.getElementById('manualWarningContent');
  
  warningContent.innerHTML = `
    <p>${checkResult.message}</p>
    <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π: <strong>${checkResult.count || 1}</strong></p>
    <p>–î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ —Ç–æ—á–µ–∫, —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ —Ä–µ–º–æ–Ω—Ç–Ω—ã–µ –∑–æ–Ω—ã.</p>
  `;
  
  warningDiv.style.display = 'block';
}

function hideManualRouteWarning() {
  document.getElementById('manualRouteWarning').style.display = 'none';
}

function finishManualRouteAnyway() {
  hideManualRouteWarning();
  showToast('–í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ä—É—á–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã –≤ —Ä–µ–º–æ–Ω—Ç–Ω—ã—Ö –∑–æ–Ω–∞—Ö!');
  updateStatus('–í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ä—É—á–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã –≤ —Ä–µ–º–æ–Ω—Ç–Ω—ã—Ö –∑–æ–Ω–∞—Ö!');
  
  if (manualRouteYandexRouter) {
    const route = manualRouteYandexRouter.getRoutes().get(0);
    showElevationProfile(route, 'manualElevationCanvas', 'manualRouteElevation');
  }
}

function clearManualRoute() {
  manualRoutePoints = [];
  
  manualPlacemarks.forEach(pm => {
    if (pm && map.geoObjects.indexOf(pm) !== -1) {
      map.geoObjects.remove(pm);
    }
  });
  manualPlacemarks = [];
  
  if (manualRoutePolyline) {
    map.geoObjects.remove(manualRoutePolyline);
    manualRoutePolyline = null;
  }
  
  if (manualRouteYandexRouter) {
    map.geoObjects.remove(manualRouteYandexRouter);
    manualRouteYandexRouter = null;
  }
  
  document.getElementById('manualPointsList').innerHTML = '';
  document.getElementById('manualRouteStats').style.display = 'none';
  document.getElementById('manualRouteWarning').style.display = 'none';
  document.getElementById('manualElevationChart').style.display = 'none';
  
  updateStatus('–†—É—á–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç –æ—á–∏—â–µ–Ω');
}

async function checkRouteIntersects(routeGeoJSON) {
  try {
    console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –º–∞—Ä—à—Ä—É—Ç–∞:', routeGeoJSON);
    const response = await fetch('/api/check_route.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ geometry: routeGeoJSON })
    });
    
    if (!response.ok) {
      throw new Error(`Network error: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞:', data);
    return data;
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
    return {
      intersects: false,
      message: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –º–∞—Ä—à—Ä—É—Ç–∞'
    };
  }
}

function extractRouteGeoJSON(route) {
  const coords = [];
  
  try {
    const paths = route.getPaths();
    if (!paths) {
      console.warn('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—É—Ç–µ–π');
      return {
        type: 'LineString',
        coordinates: coords
      };
    }
    
    paths.each((path) => {
      const geometry = path.geometry;
      if (geometry && geometry.getType() === 'LineString') {
        const pathCoords = geometry.getCoordinates();
        if (pathCoords && Array.isArray(pathCoords)) {
          pathCoords.forEach((coord) => {
            coords.push([coord[1], coord[0]]);
          });
        }
      }
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è GeoJSON –∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
  }

  return {
    type: 'LineString',
    coordinates: coords
  };
}

function clearRouteVisuals() {
  if (multiRouter) {
    map.geoObjects.remove(multiRouter);
    multiRouter = null;
  }
  
  document.getElementById('routeStats').style.display = 'none';
  document.getElementById('routeWarning').style.display = 'none';
  document.getElementById('elevationChart').style.display = 'none';
}

function clearAll() {
  if (pointA) map.geoObjects.remove(pointA);
  if (pointB) map.geoObjects.remove(pointB);
  if (window.tempClickPlacemark) map.geoObjects.remove(window.tempClickPlacemark);

  pointA = pointB = null;
  window.tempClickPlacemark = null;
  document.getElementById('addrA').value = '';
  document.getElementById('addrB').value = '';
  
  clearRouteVisuals();
  clearManualRoute();
  
  updateStatus('–ö–∞—Ä—Ç–∞ –æ—á–∏—â–µ–Ω–∞');
}

function setPoint(type, coords, address) {
  const pm = new ymaps.Placemark(coords, {
    balloonContent: `${type === 'A' ? '–ù–∞—á–∞–ª–æ' : '–ö–æ–Ω–µ—Ü'}: ${address}`
  }, {
    preset: type === 'A' ? 'islands#redCircleDotIcon' : 'islands#yellowCircleDotIcon',
    draggable: true
  });

  pm.events.add('dragend', () => {
    const newCoords = pm.geometry.getCoordinates();
    reverseGeocode(newCoords, (newAddress) => {
      if (type === 'A') {
        document.getElementById('addrA').value = newAddress;
      } else {
        document.getElementById('addrB').value = newAddress;
      }
      updateStatus(`–¢–æ—á–∫–∞ ${type} –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞: ${newAddress}`);
    });
  });

  if (type === 'A') {
    if (pointA) map.geoObjects.remove(pointA);
    pointA = pm;
    document.getElementById('addrA').value = address;
  } else {
    if (pointB) map.geoObjects.remove(pointB);
    pointB = pm;
    document.getElementById('addrB').value = address;
  }

  map.geoObjects.add(pm);
  updateStatus(`–¢–æ—á–∫–∞ ${type} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ${address}`);
}

function reverseGeocode(coords, callback) {
  ymaps.geocode(coords, { results: 1 }).then((res) => {
    const first = res.geoObjects.get(0);
    const address = first ? first.getAddressLine() : coords.join(', ');
    callback(address);
  }).catch(() => {
    callback(coords.join(', '));
  });
}

function updateStatus(text) {
  const statusElement = document.getElementById('status');
  if (statusElement) {
    statusElement.textContent = text;
  }
}

function checkAndShowHomeButton() {
  const btn = document.getElementById('myHomeBtn');
  if (!btn) return;
  
  if (isAuthenticated && window.userData && window.userData.addres) {
    btn.style.display = 'block';
    btn.style.opacity = '1';
    btn.style.transform = 'translateY(0)';
  } else {
    btn.style.display = 'none';
  }
}

function showMyHome() {
  if (!isAuthenticated || !window.userData) {
    showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω', true);
    return;
  }

  if (userHomePlacemark) {
    map.geoObjects.remove(userHomePlacemark);
  }

  const address = window.userData.addres;

  if (address) {
    showHomeByAddress(address);
  } else {
    showToast('–ê–¥—Ä–µ—Å –¥–æ–º–∞ –Ω–µ —É–∫–∞–∑–∞–Ω –≤ –ø—Ä–æ—Ñ–∏–ª–µ', true);
  }
}

function showHomeByAddress(address) {
  ymaps.geocode(address).then(function (res) {
    const firstGeoObject = res.geoObjects.get(0);
    
    if (!firstGeoObject) {
      showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å', true);
      return;
    }

    const coords = firstGeoObject.geometry.getCoordinates();
    showHomeByCoords(coords, address);
    
  }).catch(function (error) {
    console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
    showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∞–¥—Ä–µ—Å–∞', true);
  });
}

function showHomeByCoords(coords, address) {
  userHomePlacemark = new ymaps.Placemark(coords, {
    balloonContent: `üè† –ú–æ–π –¥–æ–º: ${address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}`,
    hintContent: '–ú–æ–π –¥–æ–º'
  }, {
    preset: 'islands#homeIcon',
    iconColor: '#1e88e5'
  });

  map.geoObjects.add(userHomePlacemark);
  map.setCenter(coords, 17, {
    duration: 1000
  });
  
  setTimeout(() => {
    if (userHomePlacemark && userHomePlacemark.balloon) {
      userHomePlacemark.balloon.open();
    }
  }, 1200);
  
  updateStatus(`–ü–æ–∫–∞–∑–∞–Ω –≤–∞—à –¥–æ–º: ${address}`);
}

function loadRepairZones() {
  fetch('/api/repair_zones.php')
    .then(res => {
      if (!res.ok) {
        throw new Error('Network response was not ok');
      }
      return res.json();
    })
    .then(zones => {
      const zonesToRemove = [];
      map.geoObjects.each((geoObject) => {
        if (geoObject.options && geoObject.options._tags && 
            geoObject.options._tags.includes('repair_zone')) {
          zonesToRemove.push(geoObject);
        }
      });
      
      zonesToRemove.forEach(zone => map.geoObjects.remove(zone));
      
      zones.forEach(z => {
        try {
          const geo = JSON.parse(z.geometry);
          const coords = geo.coordinates.map(ring =>
            ring.map(p => [p[1], p[0]]) 
          );

          const createdDate = new Date(z.created_at);
          const formattedDate = createdDate.toLocaleDateString('ru-RU');
          
          const lastConfirmedDate = z.last_confirmed_at 
            ? new Date(z.last_confirmed_at).toLocaleDateString('ru-RU')
            : '–ù–∏–∫–æ–≥–¥–∞';

          const polygon = new ymaps.Polygon(
            coords,
            {
              balloonContent: `
                <div class="zone-balloon">
                  <b>${z.confirm_count === 0 ? '‚è≥ –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è' : 'üöß –†–µ–º–æ–Ω—Ç–Ω–∞—è –∑–æ–Ω–∞'}</b><br>
                  ${z.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}

                  <div style="font-size:12px;color:#666;margin-top:4px;">
                    –î–æ–±–∞–≤–ª–µ–Ω–æ: ${formattedDate}<br>
                    ${z.confirm_count > 0 ? `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: ${lastConfirmedDate}` : '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è'}
                  </div>

                  <div style="margin-top:6px;">
                    –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π: <b>${z.confirm_count}</b>
                  </div>

                  ${z.is_creator ? `
                    <div class="zone-info" style="margin-top:6px; color: #2196F3;">
                      ‚ú® –í—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å —ç—Ç–æ–π –∑–æ–Ω—ã
                    </div>
                  ` : z.confirm_count === 0 ? `
                    <button
                      onclick="confirmZone(${z.id})"
                      class="btn-zone"
                      style="margin-top:6px; background-color: #9E9E9E;">
                      –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–µ–º–æ–Ω—Ç
                    </button>
                  ` : `
                    <button
                      onclick="confirmZone(${z.id})"
                      class="btn-zone"
                      style="margin-top:6px;">
                      –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–µ–º–æ–Ω—Ç
                    </button>
                  `}
                </div>
              `
            },
            {
              fillColor: (z.color || '#FF9800') + '55',
              strokeColor: z.color || '#FF9800',
              strokeWidth: z.confirm_count === 0 ? 2 : 3,
              fillOpacity: 0.6,
              strokeStyle: z.confirm_count === 0 ? 'dash' : 'solid',
              _tags: ['repair_zone'] 
            }
          );

          map.geoObjects.add(polygon);

        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–æ–Ω—ã:', z, e);
        }
      });

    })
    .catch(err => {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–æ–Ω:', err);
      showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–æ–Ω—ã —Ä–µ–º–æ–Ω—Ç–∞', 'error', '–û—à–∏–±–∫–∞');
    });
}

function startDrawingZone() {
  if (!isAuthenticated) {
    showToast(
      `–ß—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –∑–æ–Ω—É —Ä–µ–º–æ–Ω—Ç–∞, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
       <a href="/login.html">–≤–æ–π—Ç–∏</a> –∏–ª–∏
      <a href="/register.html">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>.`,
      true
    );
    return;
  }

  updateStatus('–†–∏—Å—É–π—Ç–µ –∑–æ–Ω—É: –∫–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –≤–µ—Ä—à–∏–Ω. –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Äî –∑–∞–≤–µ—Ä—à–∏—Ç—å.');
  document.getElementById('zoneForm').style.display = 'block';

  currentPolygon = new ymaps.Polygon([], {
    balloonContent: '–ó–æ–Ω–∞ —Ä–µ–º–æ–Ω—Ç–∞ (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)'
  }, {
    fillColor: '#9E9E9E55',
    strokeColor: '#E53935',
    strokeWidth: 3,
    opacity: 0.6
  });

  map.geoObjects.add(currentPolygon);
  currentPolygon.editor.startDrawing();

  currentPolygon.events.add('dblclick', () => {
    currentPolygon.editor.stopDrawing();
  });
}

function saveZone() {
  if (!currentPolygon) return;
  currentPolygon.editor.stopDrawing();

  const rawCoords = currentPolygon.geometry.getCoordinates();
  const fixedCoords = rawCoords.map(ring =>
    ring.map(p => [p[1], p[0]]) 
  );

  fetch('/api/repair_zones.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      geometry: {
        type: 'Polygon',
        coordinates: fixedCoords
      },
      description:
        document.getElementById('zoneDescription').value || '–†–µ–º–æ–Ω—Ç'
    })
  })
  .then(res => res.json())
  .then(() => {
    updateStatus('–ó–æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
    map.geoObjects.remove(currentPolygon);
    currentPolygon = null;
    document.getElementById('zoneForm').style.display = 'none';
    loadRepairZones();
    showToast('–ó–æ–Ω–∞ —Ä–µ–º–æ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
  })
  .catch(err => {
    console.error(err);
    updateStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–æ–Ω—ã');
    showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–æ–Ω—ã', true);
  });
}

function cancelZone() {
  if (currentPolygon) {
    map.geoObjects.remove(currentPolygon);
    currentPolygon = null;
  }
  document.getElementById('zoneForm').style.display = 'none';
  document.getElementById('zoneDescription').value = '';
  updateStatus('–†–∏—Å–æ–≤–∞–Ω–∏–µ –∑–æ–Ω—ã –æ—Ç–º–µ–Ω–µ–Ω–æ');
}

function confirmZone(zoneId) {
  if (!isAuthenticated) {
    showToast('–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–æ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è', true);
    return;
  }
  
  const formData = new FormData();
  formData.append('zone_id', zoneId);
  
  fetch('/api/confirm_zone.php', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(data => {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
      });
    }
    return response.json();
  })
  .then(data => {
    if (data.error) {
      showToast(data.error, true);
    } else {
      showToast(data.message);
      loadRepairZones();
    }
  })
  .catch(error => {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–æ–Ω—ã:', error);
    showToast(error.message, true);
  });
}

function initAddressSuggestions() {
  ymaps.ready(() => {
    try {
      new ymaps.SuggestView('addrA', {
        provider: {
          suggest: (request, options) => {
            return ymaps.geocode(request, {
              results: 12,
              boundedBy: [[55.10, 36.50], [56.50, 38.50]],
              strictBounds: true
            }).then(res => {
              const items = [];
              res.geoObjects.each(go => {
                items.push({
                  displayName: go.getAddressLine(),
                  value: go.getAddressLine(),
                  coords: go.geometry.getCoordinates()
                });
              });
              return items;
            });
          }
        },
        results: 8,
        boundedBy: [[55.10, 36.50], [56.50, 38.50]],
        strictBounds: true
      }).events.add('select', e => {
        const item = e.get('item');
        if (!item) return;
        
        ymaps.geocode(item.value).then(res => {
          const geo = res.geoObjects.get(0);
          if (geo) {
            setPoint('A', geo.geometry.getCoordinates(), geo.getAddressLine());
          }
        });
      });

      new ymaps.SuggestView('addrB', {
        provider: {
          suggest: (request, options) => {
            return ymaps.geocode(request, {
              results: 12,
              boundedBy: [[55.10, 36.50], [56.50, 38.50]],
              strictBounds: true
            }).then(res => {
              const items = [];
              res.geoObjects.each(go => {
                items.push({
                  displayName: go.getAddressLine(),
                  value: go.getAddressLine(),
                  coords: go.geometry.getCoordinates()
                });
              });
              return items;
            });
          }
        },
        results: 8,
        boundedBy: [[55.10, 36.50], [56.50, 38.50]],
        strictBounds: true
      }).events.add('select', e => {
        const item = e.get('item');
        if (!item) return;
        
        ymaps.geocode(item.value).then(res => {
          const geo = res.geoObjects.get(0);
          if (geo) {
            setPoint('B', geo.geometry.getCoordinates(), geo.getAddressLine());
          }
        });
      });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–æ–≤:', error);
    }
  });
}
function showToast(text, isError = false) {
  let toast = document.getElementById('toast');

  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'toast';
    document.body.appendChild(toast);
  }

  toast.innerHTML = text;
  toast.className = 'toast' + (isError ? ' error' : '');
  toast.style.cssText = `
    position: fixed;
    top: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-primary);
    color: var(--text-primary);
    padding: 15px 25px;
    border-radius: 15px;
    font-size: 14px;
    opacity: 0;
    z-index: 10001;
    box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
    transition: all 0.3s ease;
    pointer-events: none;
    max-width: 80%;
    text-align: center;
  `;

  if (isError) {
    toast.style.color = 'var(--primary-red)';
  }

  toast.classList.add('show');
  toast.style.opacity = '1';
  toast.style.transform = 'translateX(-50%) translateY(10px)';
  toast.style.pointerEvents = 'auto';

  toast.onclick = function() {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(-50%) translateY(0)';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  };

  setTimeout(() => {
    if (toast && toast.parentNode) {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(-50%) translateY(0)';
      setTimeout(() => {
        if (toast && toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }
  }, 3000);
}

function showAlert(message, type = 'info', title = null, duration = 5000) {
  const alertId = 'alert-' + Date.now();
  const alert = document.createElement('div');
  alert.id = alertId;
  alert.className = `alert alert-${type}`;
  
  const icons = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  alert.innerHTML = `
    <div class="alert-icon">${icons[type] || icons.info}</div>
    <div class="alert-content">
      ${title ? `<div class="alert-title">${title}</div>` : ''}
      <div class="alert-message">${message}</div>
    </div>
    <button class="alert-close" onclick="document.getElementById('${alertId}').remove()">√ó</button>
  `;
  
  document.body.appendChild(alert);
  
  setTimeout(() => alert.classList.add('show'), 10);
  
  if (duration > 0) {
    setTimeout(() => {
      if (alert.parentNode) {
        alert.classList.remove('show');
        setTimeout(() => {
          if (alert.parentNode) alert.remove();
        }, 300);
      }
    }, duration);
  }
}
</script>

<div id="footer"></div>

<script>
fetch('/footer.html')
  .then(r => r.text())
  .then(html => {
    document.getElementById('footer').innerHTML = html;
    return fetch('js/footer.js');
  })
  .then(r => r.text())
  .then(script => {
    eval(script);
    initFooter();
  })
  .catch(e => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ—É—Ç–µ—Ä–∞:', e));
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const map = document.getElementById('map');
  const panel = document.querySelector('.panel');
  
  if (map && panel) {
    map.style.zIndex = '1';
    panel.style.zIndex = '1000';
    panel.style.pointerEvents = 'auto';
  }
  
  document.querySelectorAll('.panel, .my-home-btn, #openPanelBtn').forEach(el => {
    el.style.opacity = '0';
    el.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
      el.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
      el.style.opacity = '1';
      el.style.transform = 'translateY(0)';
    }, 100);
  });
  
  setTimeout(() => {
    const mainLogo = document.querySelector('.logo');
    if (mainLogo) {
      mainLogo.style.cursor = 'pointer';
      mainLogo.addEventListener('click', function(e) {
        e.preventDefault();
        if (typeof showLandingCard === 'function') {
          showLandingCard();
        }
      });
      mainLogo.title = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∞–π—Ç–µ';
    }
  }, 500);
  setTimeout(checkAndShowHomeButton, 1000);
});
</script>
</body>
</html>