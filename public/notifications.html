<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</title>
  <link rel="stylesheet" href="/style.css">
  <script src="js/init-landing.js" defer></script>
  <style>
    .notif-badge {
        display: inline-block;
        background: var(--primary-orange);
        color: white;
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 8px;
        vertical-align: top;
        min-width: 16px;
        text-align: center;
        font-weight: bold;
        line-height: 1;
    }
    
    .notif-badge:empty {
        display: none;
    }
  </style>
</head>
<body>
  <div id="header"></div>

  <div class="notifications-wrapper">
    <h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>

    <div class="notifications-list" id="notificationsPage"></div>
  </div>
  <script>
    function markAllNotificationsAsRead() {
      return fetch('/api/mark-notifications-read.php')
        .then(r => {
          if (!r.ok) throw new Error('Network response was not ok');
          return r.json();
        })
        .then(data => {
          if (data.success) {
            updateNotificationBadge();
            return true;
          }
          return false;
        })
        .catch(error => {
          console.error('Error marking notifications as read:', error);
          return false;
        });
    }
    function updateNotificationBadge() {
      fetch('/api/notification-count.php')
        .then(r => {
          if (!r.ok) throw new Error('Network response was not ok');
          return r.json();
        })
        .then(data => {
          const total = data.count || 0;
          const notificationLink = document.querySelector('a[href="/notifications.html"]');
          if (!notificationLink) return;
          let badge = notificationLink.querySelector('.notif-badge');
          
          if (total > 0) {
            if (!badge) {
              badge = document.createElement('span');
              badge.className = 'notif-badge';
              notificationLink.appendChild(badge);
            }
            badge.textContent = total;
            badge.style.display = 'inline-block';
            badge.title = '–ù–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
          } else if (badge) {
            badge.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error updating notification badge:', error);
          const badge = document.querySelector('.notif-badge');
          if (badge) {
            badge.style.display = 'none';
          }
        });
    }

    function initHeader(activePage) {
      fetch('/api/me.php')
        .then(r => {
          if (!r.ok) throw new Error();
          return r.json();
        })
        .then(user => {
          const greeting = getGreeting();

          let adminLinks = '';
          if (user.role === 'admin') {
            adminLinks = `
              <div class="admin-dropdown">
                <button class="admin-dropbtn">
                  –ê–¥–º–∏–Ω
                  <span class="admin-badge">‚öôÔ∏è</span>
                </button>
                <div class="admin-dropdown-content">
                  <a href="/admin/zones.html" class="nav-link">–ó–æ–Ω—ã —Ä–µ–º–æ–Ω—Ç–∞</a>
                  <a href="/admin/users.html" class="nav-link">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                  <a href="/admin/feedback.html" class="nav-link">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</a>
                  <a href="/admin/broadcast.html" class="nav-link">–†–∞—Å—Å—ã–ª–∫–∞</a>
                </div>
              </div>
            `;
          }


        const avatarPath = user.avatar_path ? 
        (user.avatar_path.startsWith('http') ? user.avatar_path : location.origin + user.avatar_path) :
        '/uploads/avatars/Sun.jpg';

          
          document.getElementById('nav').innerHTML = `

            <div class="user-profile-header">
              <img src="${avatarPath}" alt="–ê–≤–∞—Ç–∞—Ä" class="user-avatar" 
                  onerror="this.src='/uploads/avatars/Sun.jpg'">
              <span class="greeting">${greeting}, ${user.nickname || user.email}</span>
            </div>

            <span class="greeting">${greeting}, ${user.nickname || user.email}</span>

            <a href="/index.html" class="nav-link ${activePage === 'index' ? 'active' : ''}">–ö–∞—Ä—Ç–∞</a>
            <a href="/notifications.html" class="nav-link ${activePage === 'notifications' ? 'active' : ''}">
              –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            </a>
            <a href="/feedback.html" class="nav-link ${activePage === 'feedback' ? 'active' : ''}">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</a>
            <a href="/profile.html" class="nav-link ${activePage === 'profile' ? 'active' : ''}">–ü—Ä–æ—Ñ–∏–ª—å</a>

            ${adminLinks}

            <a href="/api/logout.php" class="nav-link">–í—ã—Ö–æ–¥</a>
          `;
          setTimeout(() => {
            updateNotificationBadge();
          }, 100);
        })
        .catch(() => {
          document.getElementById('nav').innerHTML = `
            <a href="/index.html" class="nav-link">–ö–∞—Ä—Ç–∞</a>
            <a href="/login.html" class="nav-link">–í—Ö–æ–¥</a>
            <a href="/register.html" class="nav-link">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
          `;
        });
    }

    function getGreeting() {
      const hour = new Date().getHours();
      if (hour >= 5 && hour < 12) return '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ';
      if (hour >= 12 && hour < 17) return '–î–æ–±—Ä—ã–π –¥–µ–Ω—å';
      if (hour >= 17 && hour < 23) return '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä';
      return '–î–æ–±—Ä–æ–π –Ω–æ—á–∏';
    }

    async function renderNotifications() {
      const box = document.getElementById('notificationsPage');
      box.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">–ó–∞–≥—Ä—É–∑–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...</div>';

      try {
        const response = await fetch('/api/notifications.php');
        if (!response.ok) throw new Error();
        const list = await response.json();
        
        if (!Array.isArray(list) || !list.length) {
          box.innerHTML = `
            <div class="no-feedbacks">
              –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            </div>
          `;
          return;
        }
        await markAllNotificationsAsRead();
        box.innerHTML = list.map(n => {
          const isFeedback = n.source === 'feedback';
        
          const showZoneLink = n.link && !isFeedback;

          return `
            <div class="notification-item ${isFeedback ? 'feedback-reply' : ''}">
              <div class="notification-header">
                <span class="notification-icon">
                  ${isFeedback ? 'üí¨' : 'üîî'}
                </span>
                <span class="notification-title">
                  ${isFeedback ? '–û—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : n.title}
                </span>
              </div>

              <div class="notification-date">
                ${new Date(n.created_at).toLocaleString('ru-RU')}
              </div>

              <div class="notification-message">
                ${n.message}
              </div>

              <div class="notification-actions">
                ${isFeedback ? `
                  <a href="${n.link}" class="feedback-link">
                    –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–±—Ä–∞—â–µ–Ω–∏—é
                  </a>
                ` : ''}
                
                ${showZoneLink ? `
                  <a href="${n.link}" class="zone-link">
                    –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–æ–Ω—É –Ω–∞ –∫–∞—Ä—Ç–µ
                  </a>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading notifications:', error);
        box.innerHTML = `
          <div class="no-feedbacks" style="color: var(--primary-red);">
            –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
          </div>
        `;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      fetch('/header.html')
        .then(r => r.text())
        .then(html => {
          document.getElementById('header').innerHTML = html;
          initHeader('notifications');
        })
        .catch(error => {
          console.error('Error loading header:', error);
        });
      renderNotifications();
      setInterval(updateNotificationBadge, 30000);
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      function showLandingCard() {
        window.location.href = '/index.html';
      }
      
      const logos = document.querySelectorAll('.logo');
      logos.forEach(logo => {
        logo.style.cursor = 'pointer';
        logo.title = '–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≥–ª–∞–≤–Ω—É—é';
        logo.addEventListener('click', function(e) {
          e.preventDefault();
          showLandingCard();
        });
      });
    });
  </script>
</body>
</html>