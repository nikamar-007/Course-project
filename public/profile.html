<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ü—Ä–æ—Ñ–∏–ª—å</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://api-maps.yandex.ru/2.1/?apikey=9f0428a7-7d03-4225-b272-0d138349ff59&lang=ru_RU"></script>
</head>
<body>
    <div id="map"></div>
    <div id="map-toast" class="toast"></div>
    <div id="header"></div>
    <div class="profile-wrapper">
      <div class="profile-card">

        <form id="profileForm" enctype="multipart/form-data">
          <div class="avatar-block">
            <img id="avatarPreview" src="/uploads/avatars/Sun.jpg" width="96" height="96" loading="lazy" decoding="async">
            <input type="file" name="avatar" id="avatarInput" accept="image/*">
          </div>

          <label>Email</label>
          <input type="email" id="email" disabled>

          <label>–ù–∏–∫–Ω–µ–π–º</label>
          <input type="text" name="nickname" id="nickname">

          <label>–ê–¥—Ä–µ—Å</label>
          <input type="text" id="address" name="address" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞ –∫–∞—Ä—Ç–µ">

          <label>–ü–æ–ª</label>
          <select name="gender" id="gender">
            <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
            <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
            <option value="male">–ú—É–∂—Å–∫–æ–π</option>
          </select>

          <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <input type="date" name="birth_date" id="birth_date">

          <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
          <input type="password" name="password" autocomplete="new-password">

          <label>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
          <input type="password" name="password_repeat" autocomplete="new-password">

          <div id="createdAt"></div>
          <div class="profile-actions">
              <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button type="button" id="cancelBtn">–û—Ç–º–µ–Ω–∞</button>
              <button type="button" id="myZonesBtn">–ú–æ–∏ –∑–æ–Ω—ã</button>
              <button type="button" id="zonesInMyYardBtn">–ó–æ–Ω—ã –≤ –º–æ–µ–º –¥–≤–æ—Ä–µ</button>
          </div>
        </form>
      </div>
    </div>
<div id="myZonesModal" class="zones-modal">
    <div class="zones-modal-content">
        <span class="zones-modal-close">&times;</span>
        <h2>–ú–æ–∏ –∑–æ–Ω—ã</h2>
        <div id="myZonesList" class="zones-list"></div>
    </div>
</div>
<div id="yardZonesModal" class="zones-modal">
    <div class="zones-modal-content">
        <span class="zones-modal-close">&times;</span>
        <h2>–ó–æ–Ω—ã –≤ –º–æ–µ–º –¥–≤–æ—Ä–µ</h2>
        <div id="yardZonesList" class="zones-list"></div>
    </div>
</div>
<div id="editZoneModal" class="zones-modal">
    <div class="zones-modal-content">
        <span class="zones-modal-close">&times;</span>
        <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–æ–Ω—É</h2>
        <div id="editZoneContent">
            <div id="editMap" style="height: 300px; margin-bottom: 20px;"></div>
            <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
            <textarea id="editZoneDescription" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É..." rows="4"></textarea>
            <div class="edit-zone-actions">
                <button id="saveZoneChanges">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                <button id="cancelZoneEdit" class="btn-yellow">–û—Ç–º–µ–Ω–∞</button>
                <button id="deleteZone" class="btn-danger">–£–¥–∞–ª–∏—Ç—å –∑–æ–Ω—É</button>
            </div>
        </div>
    </div>
</div>

<div id="footer"></div>
    <script>
  fetch('/footer.html')
    .then(r => r.text())
    .then(html => {
      document.getElementById('footer').innerHTML = html;
      return fetch('js/footer.js');
    })
    .then(r => r.text())
    .then(script => {
      eval(script);
      initFooter();
    })
    .catch(e => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ—É—Ç–µ—Ä–∞:', e));
  </script>
    <div id="toast" class="toast"></div>

<script>
fetch('/api/me.php')
    .then(r => {
        console.log('–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', r.status);
        if (!r.ok) {
            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        }
        return r.json();
    })
    .then(user => {
        console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', user);
        window.userData = user;
    })
    .catch(error => {
        console.log('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
    });
</script>
<script>
fetch('/header.html')
  .then(r => r.text())
  .then(html => {
    document.getElementById('header').innerHTML = html;
    initHeader('profile'); 
  });


function getGreeting() {
  const hour = new Date().getHours();
  if (hour >= 5 && hour < 12) return '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ';
  if (hour >= 12 && hour < 17) return '–î–æ–±—Ä—ã–π –¥–µ–Ω—å';
  if (hour >= 17 && hour < 23) return '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä';
  return '–î–æ–±—Ä–æ–π –Ω–æ—á–∏';
}

function initHeader(activePage) {
  fetch('/api/me.php')
    .then(r => {
      if (!r.ok) throw new Error();
      return r.json();
    })
    .then(user => {
      const greeting = getGreeting();

      let adminLinks = '';
      if (user.role === 'admin') {
        adminLinks = `
          <div class="admin-dropdown">
            <button class="admin-dropbtn">
              –ê–¥–º–∏–Ω
              <span class="admin-badge">‚öôÔ∏è</span>
            </button>
            <div class="admin-dropdown-content">
              <a href="/admin/zones.html" class="nav-link">–ó–æ–Ω—ã —Ä–µ–º–æ–Ω—Ç–∞</a>
              <a href="/admin/users.html" class="nav-link">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
              <a href="/admin/feedback.html" class="nav-link">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</a>
              <a href="/admin/broadcast.html" class="nav-link">–†–∞—Å—Å—ã–ª–∫–∞</a>
            </div>
          </div>
        `;
      }

      document.getElementById('nav').innerHTML = `
        <span class="greeting">${greeting}, ${user.nickname || user.email}</span>
        <a href="/index.html" class="nav-link ${activePage === 'map' ? 'active' : ''}">–ö–∞—Ä—Ç–∞</a>
        <a href="/notifications.html" class="nav-link ${activePage === 'notifications' ? 'active' : ''}">
          –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
          ${user.unread_notifications > 0 ? `<span class="notif-badge">${user.unread_notifications}</span>` : ''}
        </a>
        <a href="/feedback.html" class="nav-link">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</a>
        <a href="/profile.html" class="nav-link ${activePage === 'profile' ? 'active' : ''}">–ü—Ä–æ—Ñ–∏–ª—å</a>
        ${adminLinks}
        <a href="/api/logout.php" class="nav-link">–í—ã—Ö–æ–¥</a>
      `;
    })
    .catch(() => {
      document.getElementById('nav').innerHTML = `
        <a href="/index.html" class="nav-link">–ö–∞—Ä—Ç–∞</a>
        <a href="/login.html" class="nav-link">–í—Ö–æ–¥</a>
        <a href="/register.html" class="nav-link">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
      `;
    });
}
</script>

<script>
function showToast(text, isError = false) {
    const toast = document.getElementById('toast') || document.getElementById('map-toast');
    if (!toast) return;
    toast.textContent = text;
    toast.className = isError ? 'toast error show' : 'toast show';
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

let windowUserData = null;
let initialProfileState = null;
let originalFormData = {};
let selectedCoords = null;
let map = null;
let placemark = null;

ymaps.ready(function() {
  map = new ymaps.Map('map', {
    center: [55.751244, 37.618423],
    zoom: 12,
    controls: ['zoomControl']
  });
  map.events.add('click', onMapClick);
  console.log('–ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
});

function loadProfile() {
  fetch('/api/me.php')
    .then(r => {
      if (!r.ok) {
        window.location.href = '/login.html';
        throw new Error('Not authorized');
      }
      return r.json();
    })
    .then(user => {
      window.userData = user; 
      console.log('User data loaded:', user);
      document.getElementById('email').value = user.email || '';
      document.getElementById('nickname').value = user.nickname || '';
      document.getElementById('address').value = user.address || '';
      document.getElementById('gender').value = user.gender || '';
      document.getElementById('birth_date').value = user.birth_date || '';
      originalFormData = {
        nickname: user.nickname || '',
        address: user.address || '',
        gender: user.gender || '',
        birth_date: user.birth_date || '',
        lat: user.lat || user.latitude || '',
        lon: user.lon || user.longitude || user.lng || ''
      };
      const avatarEl = document.getElementById('avatarPreview');
      const PLACEHOLDER = '/uploads/avatars/Sun.jpg';

      let newSrc = PLACEHOLDER;
      if (user.avatar_path && String(user.avatar_path).trim() !== '') {
        newSrc = user.avatar_path.startsWith('http')
          ? user.avatar_path
          : location.origin + user.avatar_path;
      }
      if (avatarEl.src !== newSrc) {
        avatarEl.src = newSrc;
      }
      avatarEl.onerror = () => {
        if (avatarEl.dataset.fallbackDone) return;
        avatarEl.dataset.fallbackDone = '1';
        avatarEl.src = PLACEHOLDER;
      };
      if (user.created_at) {
        document.getElementById('createdAt').innerText =
          '–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + new Date(user.created_at).toLocaleDateString('ru-RU');
      }
      initialProfileState = {
        nickname: user.nickname || '',
        address: user.address || '',
        gender: user.gender || '',
        birth_date: user.birth_date || ''
      };
      setUserHomePoint(user);
    })
    .catch(err => {
      console.error('Error loading profile:', err);
    });
}
function setUserHomePoint(user) {
  const lat = user.lat || user.latitude;
  const lon = user.lon || user.longitude || user.lng;
  
  if (lat && lon) {
    console.log('–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ—á–∫—É –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º:', lat, lon);
    setHomePoint(lat, lon, '–ú–æ–π –¥–æ–º');
  } else if (user.address) {
    console.log('–ì–µ–æ–∫–æ–¥–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å:', user.address);
    geocodeAddress(user.address);
  } else {
    console.log('–ù–µ—Ç –Ω–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç, –Ω–∏ –∞–¥—Ä–µ—Å–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ—á–∫–∏');
  }
}
function geocodeAddress(address) {
  if (!window.ymaps) {
    console.error('Yandex Maps API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    return;
  }
  
  ymaps.geocode(address).then(function(res) {
    const firstGeoObject = res.geoObjects.get(0);
    if (firstGeoObject) {
      const coords = firstGeoObject.geometry.getCoordinates();
      console.log('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã –ø–æ –∞–¥—Ä–µ—Å—É:', coords);
      setHomePoint(coords[0], coords[1], '–ú–æ–π –¥–æ–º');
    } else {
      console.log('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–∏');
    }
  }).catch(function(err) {
    console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
  });
}
function setHomePoint(lat, lon, title) {
  if (!map) {
    console.error('–ö–∞—Ä—Ç–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
    return;
  }
  if (placemark) {
    map.geoObjects.remove(placemark);
  }
  placemark = new ymaps.Placemark([lat, lon], {
    balloonContent: title,
    iconCaption: title
  }, {
    preset: 'islands#greenHomeIcon',
    draggable: true
  });
  
  map.geoObjects.add(placemark);
  
  selectedCoords = [lat, lon];
  map.setCenter([lat, lon], 17);
  
  console.log('–ú–µ—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', lat, lon, title);
  
  placemark.events.add('dragend', function() {
    const coords = placemark.geometry.getCoordinates();
    selectedCoords = coords;
    
    ymaps.geocode(coords).then(function(res) {
      const first = res.geoObjects.get(0);
      if (first) {
        const address = first.getAddressLine();
        document.getElementById('address').value = address;
      }
    });
  });
}

document.addEventListener('DOMContentLoaded', loadProfile);

document.getElementById('profileForm').addEventListener('submit', function (e) {
  e.preventDefault();

  const currentData = {
    nickname: document.getElementById('nickname').value,
    address: document.getElementById('address').value,
    gender: document.getElementById('gender').value,
    birth_date: document.getElementById('birth_date').value,
    lat: selectedCoords ? selectedCoords[0] : '',
    lon: selectedCoords ? selectedCoords[1] : ''
  };

  const password = document.querySelector('[name="password"]').value;
  const passwordRepeat = document.querySelector('[name="password_repeat"]').value;
  if (password !== passwordRepeat) {
    showToast('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', true);
    return;
  }
  let hasChanges = false;
  for (let key in currentData) {
    if (currentData[key] !== originalFormData[key]) {
      hasChanges = true;
      break;
    }
  }
  if (password || passwordRepeat) {
    hasChanges = true;
  }
  const avatarInput = document.getElementById('avatarInput');
  if (avatarInput.files.length > 0) {
    hasChanges = true;
  }

  if (!hasChanges) {
    showToast('–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', false);
    return;
  }

  const formData = new FormData(this);
  if (selectedCoords) {
    formData.append('lat', selectedCoords[0]);
    formData.append('lon', selectedCoords[1]);
  }

  fetch('/api/update_profile.php', {
    method: 'POST',
    body: formData
  })
    .then(async r => {
      const text = await r.text();
      console.log('Server response:', text);
      try {
        return JSON.parse(text);
      } catch (e) {
        console.error('Failed to parse JSON:', text);
        return { success: false, error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' };
      }
    })
    .then(res => {
      if (res.success) {
        showToast('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        loadProfile();
      } else {
        showToast(res.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞', true);
      }
    })
    .catch(err => {
      console.error('Error updating profile:', err);
      showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', true);
    });
});

document.getElementById('cancelBtn').addEventListener('click', () => {
  if (!initialProfileState) return;

  document.getElementById('nickname').value = initialProfileState.nickname;
  document.getElementById('address').value = initialProfileState.address;
  document.getElementById('gender').value = initialProfileState.gender;
  document.getElementById('birth_date').value = initialProfileState.birth_date;

  document.querySelector('[name="password"]').value = '';
  document.querySelector('[name="password_repeat"]').value = '';

  showToast('–ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω—ã');
});
document.getElementById('avatarInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('avatarPreview').src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
});
function onMapClick(e) {
  if (!map) return;
  
  const coords = e.get('coords');
  fetch('/api/check_yard.php', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      lat: coords[0],
      lng: coords[1]
    })
  })
  .then(r => r.json())
  .then(res => {
    if (!res.inside) {
      showToast('–í—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –¥–≤–æ—Ä–æ–≤–æ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏');
      return;
    }
    setHomePoint(coords[0], coords[1], '–ú–æ–π –¥–æ–º');
    ymaps.geocode(coords).then(function(res) {
      const first = res.geoObjects.get(0);
      if (first) {
        const address = first.getAddressLine();
        document.getElementById('address').value = address;
      }
    });
  })
  .catch(err => {
    console.error(err);
    showToast('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏');
  });
}
</script>

<script>
function makeDraggable(element) {
  let isDragging = false;
  let offsetX = 0;
  let offsetY = 0;
  
  const header = element.querySelector('.panel-header') || element.querySelector('.panel-title') || element;
  
  header.style.cursor = 'move';
  
  header.addEventListener('mousedown', function(e) {
    isDragging = true;
    offsetX = e.clientX - element.offsetLeft;
    offsetY = e.clientY - element.offsetTop;
    element.style.transition = 'none';
    element.style.zIndex = '10002';
    
    e.preventDefault();
  });
  
  document.addEventListener('mousemove', function(e) {
    if (!isDragging) return;
    
    const x = e.clientX - offsetX;
    const y = e.clientY - offsetY;
    const maxX = window.innerWidth - element.offsetWidth;
    const maxY = window.innerHeight - element.offsetHeight;
    
    element.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
    element.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
  });
  
  document.addEventListener('mouseup', function() {
    if (isDragging) {
      isDragging = false;
      element.style.transition = 'all 0.3s ease';
      setTimeout(() => {
        element.style.zIndex = '10001';
      }, 300);
    }
  });
}
document.addEventListener('DOMContentLoaded', function() {
  const profileCard = document.querySelector('.profile-card');
  if (profileCard) {
    makeDraggable(profileCard);
  }
});
</script>


<script>
function showAlert(message, type = 'info', title = null, duration = 5000) {
  const alertId = 'alert-' + Date.now();
  const alert = document.createElement('div');
  alert.id = alertId;
  alert.className = `alert alert-${type}`;
  
  const icons = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  alert.innerHTML = `
    <div class="alert-icon">${icons[type] || icons.info}</div>
    <div class="alert-content">
      ${title ? `<div class="alert-title">${title}</div>` : ''}
      <div class="alert-message">${message}</div>
    </div>
    <button class="alert-close" onclick="document.getElementById('${alertId}').remove()">√ó</button>
  `;
  
  document.body.appendChild(alert);
  
  setTimeout(() => alert.classList.add('show'), 10);
  
  if (duration > 0) {
    setTimeout(() => {
      if (alert.parentNode) {
        alert.classList.remove('show');
        setTimeout(() => {
          if (alert.parentNode) alert.remove();
        }, 300);
      }
    }, duration);
  }
  
  return alertId;
}
window.originalAlert = window.alert;
window.alert = function(message, type = 'info') {
  showAlert(message, type === 'error' ? 'error' : 'info');
};
function showSuccess(message, title = '–£—Å–ø–µ—à–Ω–æ') {
  return showAlert(message, 'success', title);
}
function showError(message, title = '–û—à–∏–±–∫–∞') {
  return showAlert(message, 'error', title);
}
function showWarning(message, title = '–í–Ω–∏–º–∞–Ω–∏–µ') {
  return showAlert(message, 'warning', title);
}

function showInfo(message, title = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è') {
  return showAlert(message, 'info', title);
}
</script>


<script>
ymaps.ready(() => {
  const addressInput = document.getElementById('address');
  if (!addressInput) return;
  const suggestView = new ymaps.SuggestView('address', {
    provider: {
      suggest: (request, options) => {
        return ymaps.geocode(request, {
          results: 10,
          boundedBy: [[55.0, 36.8], [56.2, 38.2]], 
          strictBounds: true
        }).then(res => {
          const items = [];
          res.geoObjects.each(go => {
            items.push({
              displayName: go.getAddressLine(),
              value: go.getAddressLine(),
              coords: go.geometry.getCoordinates()
            });
          });
          return items;
        });
      }
    },
    results: 8,
    boundedBy: [[55.0, 36.8], [56.2, 38.2]],
    strictBounds: true
  });
  suggestView.events.add('select', (e) => {
    const item = e.get('item');
    if (!item) return;

    const selectedAddress = item.value || item.displayName;
    addressInput.value = selectedAddress;
    ymaps.geocode(selectedAddress).then(res => {
      const geo = res.geoObjects.get(0);
      if (geo) {
        const coords = geo.geometry.getCoordinates();
        fetch('/api/check_yard.php', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            lat: coords[0],
            lng: coords[1]
          })
        })
        .then(r => r.json())
        .then(res => {
          if (!res.inside) {
            showToast('–í—ã–±—Ä–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –¥–≤–æ—Ä–æ–≤–æ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏', true);
            return;
          }
          setHomePoint(coords[0], coords[1], selectedAddress);
          document.getElementById('address').value = selectedAddress;
          selectedCoords = coords;
        })
        .catch(err => {
          console.error(err);
          showToast('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏', true);
        });
      }
    });
  });
  addressInput.addEventListener('blur', () => {
    const val = addressInput.value.trim();
    if (val.length < 5) return;

    ymaps.geocode(val).then(res => {
      const geo = res.geoObjects.get(0);
      if (geo) {
        const coords = geo.geometry.getCoordinates();
        const address = geo.getAddressLine();
        fetch('/api/check_yard.php', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            lat: coords[0],
            lng: coords[1]
          })
        })
        .then(r => r.json())
        .then(res => {
          if (!res.inside) {
            showToast('–í—ã–±—Ä–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –¥–≤–æ—Ä–æ–≤–æ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏', true);
            document.getElementById('address').value = '';
            if (placemark) {
              map.geoObjects.remove(placemark);
              placemark = null;
              selectedCoords = null;
            }
            return;
          }
          setHomePoint(coords[0], coords[1], address);
          document.getElementById('address').value = address;
          selectedCoords = coords;
        })
        .catch(err => {
          console.error(err);
          showToast('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏', true);
        });
      }
    }).catch(() => {
      showToast('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω', true);
    });
  });
});


</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const profileCard = document.querySelector('.profile-card');
    const mapElement = document.getElementById('map');
    
    if (!profileCard || !mapElement) return;
    const interactiveElements = profileCard.querySelectorAll(
        'input, select, button, textarea, label, .avatar-block, .profile-actions'
    );
    
    interactiveElements.forEach(el => {
        el.style.pointerEvents = 'auto';
        el.style.cursor = 'default';
        el.style.zIndex = '10001';
        el.addEventListener('mouseenter', function(e) {
            e.stopPropagation();
            mapElement.style.pointerEvents = 'none';
            document.body.classList.add('profile-card-hover');
        });
        
        el.addEventListener('mouseleave', function(e) {
            if (!profileCard.matches(':hover')) {
                mapElement.style.pointerEvents = 'auto';
                document.body.classList.remove('profile-card-hover');
            }
        });
    });
    profileCard.addEventListener('mouseenter', function(e) {
        e.stopPropagation();
        mapElement.style.pointerEvents = 'none';
        document.body.classList.add('profile-card-hover');
    });
    
    profileCard.addEventListener('mouseleave', function(e) {
        mapElement.style.pointerEvents = 'auto';
        document.body.classList.remove('profile-card-hover');
    });
    const header = profileCard.querySelector('.panel-header') || 
                   profileCard.querySelector('h2') || 
                   profileCard;
    
    header.style.cursor = 'move';
    makeDraggable(profileCard);
    
    console.log('–ö–∞—Ä—Ç–∞-—Ñ–∏–∫—Å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è —Ç–µ–ø–µ—Ä—å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã');
});
function makeDraggable(element) {
  let isDragging = false;
  let offsetX = 0;
  let offsetY = 0;
  
  const header = element.querySelector('.panel-header') || element;
  
  header.addEventListener('mousedown', function(e) {
    if (e.target.tagName === 'INPUT' || 
        e.target.tagName === 'SELECT' || 
        e.target.tagName === 'BUTTON' ||
        e.target.tagName === 'TEXTAREA') {
      return;
    }
    
    isDragging = true;
    offsetX = e.clientX - element.offsetLeft;
    offsetY = e.clientY - element.offsetTop;
    element.style.transition = 'none';
    element.style.zIndex = '10002';
    document.getElementById('map').style.pointerEvents = 'none';
    
    e.preventDefault();
  });
  
  document.addEventListener('mousemove', function(e) {
    if (!isDragging) return;
    
    const x = e.clientX - offsetX;
    const y = e.clientY - offsetY;
    
    const maxX = window.innerWidth - element.offsetWidth;
    const maxY = window.innerHeight - element.offsetHeight;
    
    element.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
    element.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
  });
  
  document.addEventListener('mouseup', function() {
    if (isDragging) {
      isDragging = false;
      element.style.transition = 'all 0.3s ease';
      setTimeout(() => {
        document.getElementById('map').style.pointerEvents = 'auto';
        element.style.zIndex = '10001';
      }, 100);
    }
  });
}
</script>

<script>
document.addEventListener('focusin', function(e) {
    if (e.target.closest('.profile-card')) {
        const map = document.getElementById('map');
        if (map) {
            map.style.pointerEvents = 'none';
        }
    }
});

document.addEventListener('focusout', function(e) {
    if (!e.target.closest('.profile-card')) {
        const map = document.getElementById('map');
        if (map) {
            map.style.pointerEvents = 'auto';
        }
    }
});

window.addEventListener('load', function() {
    setTimeout(() => {
        const inputs = document.querySelectorAll('.profile-card input, .profile-card select, .profile-card button');
        inputs.forEach(input => {
            input.style.pointerEvents = 'auto';
            input.style.cursor = 'auto';
            input.style.zIndex = '10003';
            input.setAttribute('tabindex', '0');
        });
        const map = document.getElementById('map');
        if (map) {
            map.style.pointerEvents = 'none';
        }
        document.addEventListener('mousemove', function(e) {
            if (!e.target.closest('.profile-card')) {
                map.style.pointerEvents = 'auto';
            }
        });
    }, 100);
});
</script>

<script>
function checkApiEndpoints() {
    const endpoints = [
        '/api/my_zones.php',
        '/api/zones_in_my_yard.php',
        '/api/repair_zones.php'
    ];
    
    endpoints.forEach(endpoint => {
        fetch(endpoint, { method: 'HEAD' })
            .then(response => {
                console.log(`${endpoint}: ${response.ok ? 'OK' : 'ERROR'} (${response.status})`);
            })
            .catch(error => {
                console.error(`${endpoint}: ${error.message}`);
            });
    });
}

let myZones = [];
let yardZones = [];
let editingZoneId = null;
let editZoneMap = null;
let editZonePolygon = null;

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('myZonesBtn').addEventListener('click', function() {
        loadMyZones();
        document.getElementById('myZonesModal').style.display = 'block';
    });
    
    document.getElementById('zonesInMyYardBtn').addEventListener('click', function() {
        loadZonesInMyYard();
        document.getElementById('yardZonesModal').style.display = 'block';
    });
    
    document.querySelectorAll('.zones-modal-close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function() {
            this.closest('.zones-modal').style.display = 'none';
        });
    });
    
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('zones-modal')) {
            event.target.style.display = 'none';
        }
    });
    
    document.getElementById('saveZoneChanges').addEventListener('click', saveZoneChanges);
    document.getElementById('cancelZoneEdit').addEventListener('click', function() {
        document.getElementById('editZoneModal').style.display = 'none';
        if (editZonePolygon && editZonePolygon.editor) {
            editZonePolygon.editor.stopEditing();
        }
    });
    document.getElementById('deleteZone').addEventListener('click', deleteCurrentZone);
  
    loadUserData();
});



function loadUserData() {
    fetch('/api/me.php')
        .then(r => {
            if (r.ok) return r.json();
            throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        })
        .then(user => {
            window.userData = user;
        })
        .catch(err => {
            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', err);
        });
}


async function apiCall(url, options = {}) {
    try {
        const response = await fetch(url, options);
        
        if (!response.ok) {
            let errorText = await response.text();
            try {
                const errorJson = JSON.parse(errorText);
                throw new Error(errorJson.error || `HTTP error ${response.status}`);
            } catch {
                throw new Error(errorText || `HTTP error ${response.status}`);
            }
        }
        
        return await response.json();
    } catch (error) {
        console.error('API Error:', error);
        throw error;
    }
}


async function loadMyZones() {
    try {
        const response = await fetch('/api/my_zones.php');
        
        if (!response.ok) {
            console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ');
            myZones = getTestZones();
            renderZonesList('myZonesList', myZones, true);
            return;
        }
        
        myZones = await response.json();
        renderZonesList('myZonesList', myZones, true);
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:', error);
        myZones = getTestZones();
        renderZonesList('myZonesList', myZones, true);
    }
}



function getTestZones() {
    return [
        {
            id: 1,
            description: '–†–µ–º–æ–Ω—Ç –¥–æ—Ä–æ–≥–∏ —É –ø–æ–¥—ä–µ–∑–¥–∞ 1',
            confirm_count: 3,
            created_at: '2024-01-15T10:00:00',
            last_confirmed_at: '2024-01-20T08:30:00',
            creator_id: 1,
            color: '#E53935',
            geometry: '{"type":"Polygon","coordinates":[[[37.6173,55.7558],[37.6175,55.7559],[37.6176,55.7557],[37.6174,55.7556],[37.6173,55.7558]]]}'
        },
        {
            id: 2,
            description: '–†–µ–º–æ–Ω—Ç –¥–µ—Ç—Å–∫–æ–π –ø–ª–æ—â–∞–¥–∫–∏',
            confirm_count: 0,
            created_at: '2024-01-20T14:30:00',
            last_confirmed_at: null,
            creator_id: 2,
            color: '#9E9E9E',
            geometry: '{"type":"Polygon","coordinates":[[[37.6180,55.7560],[37.6182,55.7561],[37.6183,55.7559],[37.6181,55.7558],[37.6180,55.7560]]]}'
        }
    ];
}



async function loadZonesInMyYard() {
    try {
        const zones = await apiCall('/api/zones_in_my_yard.php');
        yardZones = zones;
        renderZonesList('yardZonesList', yardZones, false);
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–æ–Ω –≤ –¥–≤–æ—Ä–µ:', error);
        const errorMessage = error.message.includes('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è') 
            ? '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.'
            : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–æ–Ω: ' + error.message;
        
        document.getElementById('yardZonesList').innerHTML = 
            `<div class="empty-message">${errorMessage}</div>`;
    }
}
function renderZonesList(containerId, zones, isMyZones) {
    const container = document.getElementById(containerId);
    
    if (!zones || zones.length === 0) {
        container.innerHTML = '<div class="empty-message">–ó–æ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
    }
    
    let html = '';
    zones.forEach(zone => {
        const currentUserId = getCurrentUserId();
        const isCreator = zone.creator_id == currentUserId;
        const statusClass = getZoneStatusClass(zone);
        const statusText = getZoneStatusText(zone);
        const createdDate = new Date(zone.created_at).toLocaleDateString('ru-RU');
        const lastConfirmed = zone.last_confirmed_at ? 
            new Date(zone.last_confirmed_at).toLocaleDateString('ru-RU') : '‚Äî';
        
        html += `
            <div class="zone-item ${statusClass}">
                <div class="zone-header">
                    <div class="zone-title">–ó–æ–Ω–∞ #${zone.id}</div>
                    <span class="zone-status ${statusClass}">${statusText}</span>
                </div>
                <div class="zone-description">${zone.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                <div class="zone-meta">
                    <span>–°–æ–∑–¥–∞–Ω–∞: ${createdDate}</span>
                    <span>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π: ${zone.confirm_count || 0}</span>
                    <span>–ü–æ—Å–ª–µ–¥–Ω–µ–µ: ${lastConfirmed}</span>
                </div>
                <div class="zone-actions">
                    <button class="zone-action-btn view" onclick="viewZoneOnMap(${zone.id})">
                        üëÅ –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ
                    </button>
                    ${isCreator ? `
                        <button class="zone-action-btn edit" onclick="editZone(${zone.id})">
                            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button class="zone-action-btn delete" onclick="confirmDeleteZone(${zone.id})">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}



function getCurrentUserId() {
    if (window.userData && window.userData.id) {
        return window.userData.id;
    }
    const userDataStr = localStorage.getItem('userData') || sessionStorage.getItem('userData');
    if (userDataStr) {
        try {
            const userData = JSON.parse(userDataStr);
            return userData.id;
        } catch (e) {
            console.error('Error parsing user data:', e);
        }
    }
    return 0;
}

function getZoneStatusClass(zone) {
    if (zone.confirm_count === 0) return 'pending';
    if (zone.color === '#E53935') return 'active-red';
    if (zone.color === '#FBC02D') return 'active-yellow';
    if (zone.color === '#43A047') return 'expired-green';
    return 'pending';
}
function getZoneStatusText(zone) {
    if (zone.confirm_count === 0) return '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è';
    if (zone.color === '#E53935') return '–ê–∫—Ç–∏–≤–Ω–∞—è';
    if (zone.color === '#FBC02D') return '–ê–∫—Ç–∏–≤–Ω–∞—è';
    if (zone.color === '#43A047') return '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è';
    return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
}
function viewZoneOnMap(zoneId) {
    document.querySelectorAll('.zones-modal').forEach(modal => {
        modal.style.display = 'none';
    });
    window.open(`/index.html?zone=${zoneId}`, '_blank');
}



function editZone(zoneId) {
    if (!window.userData || !window.userData.id) {
        showToast('–î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–æ–Ω –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è', true);
        return;
    }
    
    editingZoneId = zoneId;
    
    const zone = [...myZones].find(z => z.id == zoneId);
    
    if (!zone) {
        showToast('–ó–æ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –≤–∞—à–µ–º —Å–ø–∏—Å–∫–µ', true);
        return;
    }
    if (zone.creator_id != window.userData.id) {
        showToast('–í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º —ç—Ç–æ–π –∑–æ–Ω—ã', true);
        return;
    }
    if (zone.is_active === false) {
        showToast('–≠—Ç–∞ –∑–æ–Ω–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞', true);
        return;
    }
    
    console.log('–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∑–æ–Ω—É:', zone);
    console.log('ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', window.userData.id);
    console.log('ID —Å–æ–∑–¥–∞—Ç–µ–ª—è –∑–æ–Ω—ã:', zone.creator_id);
    document.getElementById('editZoneDescription').value = zone.description || '';
    document.getElementById('editZoneModal').style.display = 'block';
    initEditZoneMap(zone);
}



function initEditZoneMap(zone) {
    if (!window.ymaps) {
        showToast('–ö–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', true);
        return;
    }
    
    ymaps.ready(() => {
        if (!editZoneMap) {
            editZoneMap = new ymaps.Map('editMap', {
                center: [55.7558, 37.6173],
                zoom: 15,
                controls: ['zoomControl', 'typeSelector']
            });
        }
        editZoneMap.geoObjects.removeAll();
        if (zone.geometry) {
            try {
                const geo = JSON.parse(zone.geometry);
                console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º–∞—è –≥–µ–æ–º–µ—Ç—Ä–∏—è:', geo);
                const coords = geo.coordinates[0].map(coord => [coord[1], coord[0]]);
                
                console.log('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç:', coords);
                
                editZonePolygon = new ymaps.Polygon(
                    [coords],
                    {
                        hintContent: '–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è –∑–æ–Ω–∞',
                        balloonContent: zone.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'
                    },
                    {
                        fillColor: (zone.color || '#FF9800') + '88',
                        strokeColor: zone.color || '#FF9800',
                        strokeWidth: 3,
                        fillOpacity: 0.6,
                        editorDrawingCursor: "crosshair",
                        editorMaxPoints: Infinity,
                        draggable: false
                    }
                );
                
                editZoneMap.geoObjects.add(editZonePolygon);
                editZoneMap.setBounds(editZonePolygon.geometry.getBounds(), {
                    checkZoomRange: true,
                    zoomMargin: 30
                });
                setTimeout(() => {
                    if (editZonePolygon && editZonePolygon.editor) {
                        editZonePolygon.editor.startEditing();
                        console.log('–†–µ–¥–∞–∫—Ç–æ—Ä –ø–æ–ª–∏–≥–æ–Ω–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
                    }
                }, 500);
                
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≥–µ–æ–º–µ—Ç—Ä–∏–∏:', e, zone.geometry);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–µ–æ–º–µ—Ç—Ä–∏–∏ –∑–æ–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –∑–æ–Ω—É.', true);
            }
        } else {
            showToast('–£ –∑–æ–Ω—ã –Ω–µ—Ç –≥–µ–æ–º–µ—Ç—Ä–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', true);
        }
    });
}



async function saveZoneChanges() {
    if (!window.userData || !window.userData.id) {
        showToast('–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è', true);
        return;
    }
    
    if (!editingZoneId || !editZonePolygon) {
        showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', true);
        return;
    }
    
    const description = document.getElementById('editZoneDescription').value.trim();
    if (!description) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–æ–Ω—ã', true);
        return;
    }
    
    try {
        showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–æ–Ω—ã...');
        const rawCoords = editZonePolygon.geometry.getCoordinates()[0];
        const fixedCoords = rawCoords.map(coord => [coord[1], coord[0]]);
        if (fixedCoords.length > 0) {
            const first = fixedCoords[0];
            const last = fixedCoords[fixedCoords.length - 1];
            if (first[0] !== last[0] || first[1] !== last[1]) {
                fixedCoords.push([...first]);
            }
        }
        
        const geometry = {
            type: "Polygon",
            coordinates: [fixedCoords]
        };
        
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', {
            description: description,
            geometry: geometry,
            userId: window.userData.id,
            zoneId: editingZoneId
        });
        const response = await fetch(`/api/repair_zones.php?id=${editingZoneId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                description: description,
                geometry: geometry
            })
        });
        
        console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
        
        const responseText = await response.text();
        console.log('–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:', responseText);
        
        try {
            const result = JSON.parse(responseText);
            
            if (response.ok && result.status === 'ok') {
                showToast('–ó–æ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                document.getElementById('editZoneModal').style.display = 'none';
                loadMyZones();
                loadZonesInMyYard();
                if (editZonePolygon && editZonePolygon.editor) {
                    editZonePolygon.editor.stopEditing();
                }
                
            } else {
                showToast(result.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–æ–Ω—ã', true);
            }
        } catch (e) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON:', responseText);
            showToast('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + responseText.substring(0, 100), true);
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–æ–Ω—ã:', error);
        showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–æ–Ω—ã: ' + error.message, true);
    }
}


function confirmDeleteZone(zoneId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–æ–Ω—É?')) {
        deleteZone(zoneId);
    }
}
function deleteCurrentZone() {
    if (!editingZoneId) return;
    
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–æ–Ω—É?')) {
        deleteZone(editingZoneId);
    }
}
async function deleteZone(zoneId) {
    try {
        const response = await fetch(`/api/repair_zones.php?id=${zoneId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok && result.status === 'ok') {
            showToast('–ó–æ–Ω–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞');
            document.getElementById('editZoneModal').style.display = 'none';
            loadMyZones();
            loadZonesInMyYard();
            
        } else {
            showToast(result.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–æ–Ω—ã', true);
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–æ–Ω—ã:', error);
        showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–æ–Ω—ã', true);
    }
}
</script>
</body>
</html>