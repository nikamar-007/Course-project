<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Комфортные маршруты</title>

  <!-- Вставь свой API-ключ при необходимости -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=9f0428a7-7d03-4225-b272-0d138349ff59"></script>

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --card2:#f7f9ff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:rgba(0,0,0,.08);
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --danger:#dc2626;
      --shadow: 0 14px 40px rgba(0,0,0,.12);
      --radius:16px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 30% 0%, #162a52 0%, var(--bg) 55%);
      color:var(--text);
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 22px;
      border-bottom:1px solid var(--line);
      background: rgba(15,26,46,.75);
      backdrop-filter: blur(10px);
      position: sticky;
      top:0;
      z-index:10;
    }
    header .title{
      font-weight:700;
      letter-spacing:.2px;
    }
    header .hint{
      color:var(--muted);
      font-size:13px;
    }

    .wrap{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      padding:16px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .panel{
      background: linear-gradient(180deg, var(--card) 0%, var(--card2) 100%);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      min-height: 700px;
    }

    .panel h2{
      margin:0 0 10px 0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .sub{
      margin:0 0 14px 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .grid{
      display:grid;
      gap:10px;
    }
    label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      display:block;
    }
    .field{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 12px;
      padding:10px 12px;
      color:var(--text);
      width:100%;
      outline:none;
      transition: .15s;
    }
    .field:focus{
      border-color: rgba(79,140,255,.55);
      box-shadow: 0 0 0 4px rgba(79,140,255,.15);
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .btnrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s;
      font-weight:600;
    }
    button:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.10);
    }
    .primary{
      background: linear-gradient(180deg, var(--primary) 0%, var(--primary2) 100%);
      border-color: rgba(79,140,255,.45);
    }
    .primary:hover{
      background: linear-gradient(180deg, #6aa0ff 0%, #3a79ff 100%);
    }
    .ghost{
      background: transparent;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--muted);
      font-size:12px;
      margin-top: 10px;
    }
    .pill b{ color: var(--text); font-weight:700; }

    .status{
      margin-top: 14px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      min-height: 56px;
      white-space: pre-wrap;
      line-height: 1.35;
    }

    .summary{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .metric{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding:10px 12px;
    }
    .metric .k{
      color:var(--muted);
      font-size:12px;
      margin-bottom: 6px;
    }
    .metric .v{
      font-size:16px;
      font-weight:800;
      letter-spacing:.2px;
    }

    #map{
      height: 700px;
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      border:1px solid var(--line);
      background:#0a0f1c;
    }

    @media (max-width: 1050px){
      .wrap{ grid-template-columns: 1fr; }
      .panel{ min-height: auto; }
      #map{ height: 520px; }
    }
  </style>
</head>

<body>
<header>
  <div class="title">Комфортные маршруты</div>
  <div class="hint">Пешие маршруты. Клик по карте ставит A/B. Адрес можно вводить с подсказками.</div>
</header>

<div class="wrap">
  <div class="panel">
    <h2>Пеший маршрут</h2>
    <p class="sub">
      1) Введите адрес или кликните по карте.<br>
      2) По умолчанию ставим A, затем B (можно переключать кнопками).<br>
      3) Нажмите «Построить маршрут».
    </p>

    <div class="grid">
      <div>
        <label for="addrA">Точка A (откуда)</label>
        <input id="addrA" class="field" placeholder="Начните вводить адрес…" autocomplete="off" />
      </div>

      <div>
        <label for="addrB">Точка B (куда)</label>
        <input id="addrB" class="field" placeholder="Начните вводить адрес…" autocomplete="off" />
      </div>

      <div class="row2">
        <div>
          <label for="latA">A: широта</label>
          <input id="latA" class="field" readonly />
        </div>
        <div>
          <label for="lonA">A: долгота</label>
          <input id="lonA" class="field" readonly />
        </div>
      </div>

      <div class="row2">
        <div>
          <label for="latB">B: широта</label>
          <input id="latB" class="field" readonly />
        </div>
        <div>
          <label for="lonB">B: долгота</label>
          <input id="lonB" class="field" readonly />
        </div>
      </div>

      <div class="btnrow">
        <button id="setA">Ставить A</button>
        <button id="setB">Ставить B</button>
        <button id="build" class="primary">Построить маршрут</button>
        <button id="clear" class="ghost">Очистить</button>
      </div>

      <div class="pill">Режим: <b id="modeLabel">A</b> (следующий клик по карте)</div>

      <div class="summary">
        <div class="metric">
          <div class="k">Длина маршрута</div>
          <div class="v" id="dist">—</div>
        </div>
        <div class="metric">
          <div class="k">Время в пути</div>
          <div class="v" id="time">—</div>
        </div>
      </div>

      <div id="status" class="status">Готово. Кликните по карте или введите адрес.</div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
ymaps.ready(() => {
  const map = new ymaps.Map("map", {
    center: [55.7558, 37.6176],
    zoom: 12,
    controls: ["zoomControl"]
  });

  let mode = "A";
  const modeLabel = document.getElementById("modeLabel");

  let A = null, B = null;
  let markA = null, markB = null;
  let route = null;

  const statusEl = document.getElementById("status");
  const distEl = document.getElementById("dist");
  const timeEl = document.getElementById("time");

  const latAEl = document.getElementById("latA");
  const lonAEl = document.getElementById("lonA");
  const latBEl = document.getElementById("latB");
  const lonBEl = document.getElementById("lonB");

  const addrAEl = document.getElementById("addrA");
  const addrBEl = document.getElementById("addrB");

  const msg = (t) => statusEl.textContent = t;

  // Подсказки Яндекса
  new ymaps.SuggestView("addrA");
  new ymaps.SuggestView("addrB");

  function flyTo(coords, zoom = 16) {
    // Плавная центровка и приближение к точке
    map.setCenter(coords, zoom, { duration: 350 });
  }

  function setCoordsFields(type, coords) {
    const [lat, lon] = coords;
    if (type === "A") {
      latAEl.value = lat.toFixed(6);
      lonAEl.value = lon.toFixed(6);
    } else {
      latBEl.value = lat.toFixed(6);
      lonBEl.value = lon.toFixed(6);
    }
  }

  async function reverseGeocode(coords) {
    const res = await ymaps.geocode(coords);
    const obj = res.geoObjects.get(0);
    return obj ? obj.getAddressLine() : "";
  }

  async function geocodeAddress(addr) {
    const res = await ymaps.geocode(addr);
    return res.geoObjects.get(0) || null;
  }

  function setPoint(type, coords, addressText) {
    const placemark = new ymaps.Placemark(coords, {
      iconCaption: type
    }, {
      preset: type === "A" ? "islands#blueCircleDotIcon" : "islands#violetCircleDotIcon"
    });

    if (type === "A") {
      if (markA) map.geoObjects.remove(markA);
      A = coords;
      markA = placemark;
      addrAEl.value = addressText || addrAEl.value || "";
    } else {
      if (markB) map.geoObjects.remove(markB);
      B = coords;
      markB = placemark;
      addrBEl.value = addressText || addrBEl.value || "";
    }

    map.geoObjects.add(placemark);
    setCoordsFields(type, coords);
    flyTo(coords, 17);

    msg(`Точка ${type} установлена.`);
  }

  // Клик по карте — ставим A или B
  map.events.add("click", async (e) => {
    const coords = e.get("coords");
    const addr = await reverseGeocode(coords);
    setPoint(mode, coords, addr);

    // Автопереключение A -> B после установки A
    if (mode === "A") {
      mode = "B";
      modeLabel.textContent = "B";
    }
  });

  document.getElementById("setA").onclick = () => { mode = "A"; modeLabel.textContent = "A"; msg("Режим: ставим A"); };
  document.getElementById("setB").onclick = () => { mode = "B"; modeLabel.textContent = "B"; msg("Режим: ставим B"); };

  document.getElementById("clear").onclick = () => {
    map.geoObjects.removeAll();
    A = B = null;
    markA = markB = null;
    route = null;
    addrAEl.value = "";
    addrBEl.value = "";
    latAEl.value = lonAEl.value = latBEl.value = lonBEl.value = "";
    distEl.textContent = "—";
    timeEl.textContent = "—";
    mode = "A";
    modeLabel.textContent = "A";
    msg("Очищено. Кликните по карте или введите адрес.");
  };

  // При вводе адреса — ставим точку по адресу
  async function setFromAddress(type, addr) {
    const obj = await geocodeAddress(addr);
    if (!obj) {
      msg(`Не удалось найти адрес для точки ${type}`);
      return;
    }
    const coords = obj.geometry.getCoordinates();
    const text = obj.getAddressLine();
    setPoint(type, coords, text);
  }

  // "change" срабатывает когда пользователь выбрал подсказку или ушёл из поля
  addrAEl.addEventListener("change", (e) => {
    const v = e.target.value.trim();
    if (v) setFromAddress("A", v);
  });
  addrBEl.addEventListener("change", (e) => {
    const v = e.target.value.trim();
    if (v) setFromAddress("B", v);
  });

  // Построение маршрута (как в Яндекс Картах — кратчайший пеший)
  document.getElementById("build").onclick = () => {
    if (!A || !B) {
      msg("Нужно выбрать точки A и B.");
      return;
    }

    if (route) map.geoObjects.remove(route);

    route = new ymaps.multiRouter.MultiRoute({
      referencePoints: [A, B],
      params: {
        routingMode: "pedestrian",
        results: 1 // один лучший вариант (кратчайший)
      }
    }, {
      boundsAutoApply: true
    });

    map.geoObjects.add(route);

    // Считываем длину/время, когда маршрут готов
    route.model.events.add("requestsuccess", () => {
      try {
        const activeRoute = route.getActiveRoute();
        if (!activeRoute) return;

        const dist = activeRoute.properties.get("distance");
        const time = activeRoute.properties.get("duration");

        distEl.textContent = dist && dist.text ? dist.text : "—";
        timeEl.textContent = time && time.text ? time.text : "—";

        msg("Маршрут построен.");
      } catch (e) {
        msg("Маршрут построен, но не удалось прочитать параметры.");
      }
    });

    route.model.events.add("requestfail", (e) => {
      msg("Не удалось построить маршрут: " + (e.get("error")?.message || "ошибка"));
    });
  };

  msg("Готово. Кликните по карте или введите адрес.");
});
</script>
</body>
</html>
