<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Комфортные маршруты — карта</title>

  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>

  <style>
    :root{
      --bg:#ffffff; --text:#111; --muted:#666; --border:#e5e5e5;
      --card:#fafafa; --accent:#2563eb;
      --warn-bg:#fff7ed; --warn-border:#fdba74; --warn-text:#9a3412;
    }
    body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text); }
    header{ border-bottom:1px solid var(--border); }
    .topbar{ max-width:1200px; margin:0 auto; padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .brand{ font-weight:700; }
    .nav a{ color:var(--accent); text-decoration:none; margin-left:12px; }
    .nav a:hover{ text-decoration:underline; }

    .layout{ max-width:1200px; margin:16px auto; padding:0 16px; display:grid; grid-template-columns: 420px 1fr; gap:16px; }
    @media (max-width: 980px){ .layout{ grid-template-columns:1fr; } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:10px; padding:14px; }
    label{ display:block; font-size:13px; color:var(--muted); margin-top:10px; }
    input{ width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; font-size:14px; box-sizing:border-box; background:#fff; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    button{
      margin-top:12px; padding:10px 12px; border-radius:8px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:600;
    }
    button.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .hint{ margin-top:10px; color:var(--muted); font-size:13px; line-height:1.35; }
    .warn{ display:none; margin-top:12px; padding:10px 12px; border-radius:10px; border:1px solid var(--warn-border); background:var(--warn-bg); color:var(--warn-text); }
    .status{ margin-top:12px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap; background:#fff; border:1px dashed var(--border); border-radius:10px; padding:10px; }
    #map{ width:100%; height:72vh; min-height:520px; border:1px solid var(--border); border-radius:10px; overflow:hidden; background:#f4f4f4; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .chip{ font-size:12px; padding:6px 8px; border:1px solid var(--border); border-radius:999px; background:#fff; }
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">Комфортные маршруты</div>
    <nav class="nav">
      <a href="/">Карта</a>
      <a href="/register">Регистрация</a>
      <a href="/login">Вход</a>
    </nav>
  </div>
</header>

<main class="layout">
  <section class="card">
    <h2 style="margin:0 0 8px 0;">Пеший маршрут</h2>
    <div class="hint">
    </div>

    <label>Точка A (откуда)</label>
    <input id="from" placeholder="Например: Москва, Тверская 1" />

    <label>Точка B (куда)</label>
    <input id="to" placeholder="Например: Москва, Красная площадь" />

    <div class="chips">
      <span class="chip">Режим: пешком</span>
      <span class="chip">Зоны работ: /api/repairs</span>
    </div>

    <button id="buildBtn" class="primary">Построить маршрут</button>
    <button id="clearBtn">Очистить</button>

    <div id="warn" class="warn"></div>
    <div id="status" class="status">Готово. Введите A и B, затем нажмите «Построить маршрут».</div>
  </section>

  <section>
    <div id="map"></div>
  </section>
</main>

<script>
let map;
let repairsObjects;
let repairsPolygons = [];   
let multiRoute = null;

function setStatus(text){ document.getElementById('status').textContent = text; }
function setWarn(text){
  const el = document.getElementById('warn');
  if (!text){ el.style.display='none'; el.textContent=''; return; }
  el.style.display='block';
  el.textContent = text;
}

function styleForSeverity(sev){
  // Можно расширять: red/yellow/green.
  if (sev === 'red')   return { fillColor:'#ef4444', fillOpacity:0.25, strokeColor:'#b91c1c', strokeWidth:2 };
  if (sev === 'yellow')return { fillColor:'#f59e0b', fillOpacity:0.25, strokeColor:'#b45309', strokeWidth:2 };
  if (sev === 'green') return { fillColor:'#22c55e', fillOpacity:0.20, strokeColor:'#15803d', strokeWidth:2 };
  return { fillColor:'#ef4444', fillOpacity:0.25, strokeColor:'#b91c1c', strokeWidth:2 };
}

async function loadRepairs(){
  setStatus('Загружаем зоны работ...');
  repairsObjects.removeAll();
  repairsPolygons = [];

  const r = await fetch('/api/repairs', { headers: { 'Accept':'application/json' }});
  if (!r.ok) throw new Error('Не удалось загрузить /api/repairs: ' + r.status);
  const fc = await r.json();

  if (!fc || !Array.isArray(fc.features)) {
    throw new Error('Неверный формат GeoJSON (ожидали FeatureCollection.features[])');
  }

  fc.features.forEach(f => {
    if (!f.geometry || !f.geometry.type || !f.geometry.coordinates) return;

    // Поддержим Polygon и MultiPolygon
    const sev = (f.properties && f.properties.severity) ? f.properties.severity : 'red';
    const style = styleForSeverity(sev);

    if (f.geometry.type === 'Polygon') {
      const poly = new ymaps.Polygon(f.geometry.coordinates, f.properties || {}, style);
      repairsObjects.add(poly);
      repairsPolygons.push(poly);
    } else if (f.geometry.type === 'MultiPolygon') {
      const mp = new ymaps.Polygon(f.geometry.coordinates, f.properties || {}, style); // YM Polygon умеет MultiPolygon как массив полигонов
      repairsObjects.add(mp);
      repairsPolygons.push(mp);
    }
  });

  setStatus('Зоны работ загружены: ' + repairsPolygons.length);
}

function clearRoute(){
  if (multiRoute) {
    map.geoObjects.remove(multiRoute);
    multiRoute = null;
  }
  setWarn('');
  setStatus('Маршрут очищен.');
}

function routeIntersectsRepairs(activeRoute){
  try{
    const paths = activeRoute.getPaths();
    const polys = repairsPolygons;
    let hit = null;

    paths.each(function(path){
      const coords = path.geometry.getCoordinates(); 
      const step = Math.max(1, Math.floor(coords.length / 120));
      for (let i=0; i<coords.length; i+=step){
        const p = coords[i];
        for (let j=0; j<polys.length; j++){
          if (polys[j].geometry.contains(p)) {
            hit = polys[j];
            return false; 
          }
        }
        if (hit) return false;
      }
      return !hit;
    });

    return hit;
  } catch(e){
    return null;
  }
}

function buildRoute(){
  const from = document.getElementById('from').value.trim();
  const to = document.getElementById('to').value.trim();
  if (!from || !to){
    setWarn('Введите обе точки: A и B.');
    return;
  }

  setWarn('');
  setStatus('Строим маршрут (пешком)...');

  if (multiRoute) map.geoObjects.remove(multiRoute);

  multiRoute = new ymaps.multiRouter.MultiRoute({
    referencePoints: [from, to],
    params: {
      routingMode: 'pedestrian'
    }
  }, {
    boundsAutoApply: true,
    wayPointVisible: true,
    routeActiveStrokeWidth: 6,
    routeActiveStrokeColor: '#2563eb',
    routeStrokeWidth: 4,
    routeStrokeColor: '#93c5fd'
  });

  map.geoObjects.add(multiRoute);

  multiRoute.model.events.add('requestsuccess', function(){
    const activeRoute = multiRoute.getActiveRoute();
    if (!activeRoute){
      setStatus('Маршрут не найден.');
      return;
    }

    const hit = routeIntersectsRepairs(activeRoute);
    if (hit){
      const title = hit.properties.get('title') || 'Зона работ';
      setWarn('Внимание: маршрут пересекает зону работ: ' + title + '. Попробуйте изменить точки или перетащить маршрут.');
    } else {
      setWarn('');
    }

    const dist = activeRoute.properties.get('distance');
    const time = activeRoute.properties.get('duration');
    const distText = dist ? dist.text : '—';
    const timeText = time ? time.text : '—';
    setStatus('Маршрут построен. Дистанция: ' + distText + ', время: ' + timeText + '.');
  });

  multiRoute.model.events.add('requestfail', function(e){
    setWarn('Не удалось построить маршрут. Проверьте адреса.');
    setStatus('Ошибка маршрутизации.');
  });
}

ymaps.ready(async () => {
  map = new ymaps.Map('map', {
    center: [55.7558, 37.6176],
    zoom: 12,
    controls: ['zoomControl']
  });

  repairsObjects = new ymaps.GeoObjectCollection();
  map.geoObjects.add(repairsObjects);

  document.getElementById('buildBtn').addEventListener('click', buildRoute);
  document.getElementById('clearBtn').addEventListener('click', clearRoute);

  try{
    await loadRepairs();
  } catch(e){
    setWarn('Не удалось загрузить зоны работ: ' + e.message);
    setStatus('Проверьте, что backend запущен и /api/repairs отдаёт GeoJSON.');
  }
});
</script>
</body>
</html>
